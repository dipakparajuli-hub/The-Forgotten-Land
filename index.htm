<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>THE FORGOTTEN LAND</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Creepster&family=Share+Tech+Mono&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Share Tech Mono',monospace;color:#e0e0e0;user-select:none;-webkit-user-select:none;touch-action:none;position:fixed;-webkit-overflow-scrolling:none;}
#screens>div{position:fixed;top:0;left:0;width:100%;height:100%;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);display:none;flex-direction:column;align-items:center;justify-content:center;}
#screens>div.active{display:flex;}

/* LOADING */
#loadingScreen{background:#000;z-index:100;}
.logo-wrap{text-align:center;animation:fadeInUp 1s ease forwards;}
.logo-title{font-family:'Creepster',cursive;font-size:clamp(2rem,8vw,5rem);color:#c0392b;text-shadow:0 0 40px #c0392b,0 0 80px #8e1a0e;letter-spacing:.2em;}
.logo-sub{font-size:clamp(.5rem,2vw,.9rem);color:#555;letter-spacing:.5em;margin-top:.5rem;}
.loading-bar-wrap{margin-top:2rem;width:min(300px,70vw);height:2px;background:#111;border:1px solid #222;}
.loading-bar{height:100%;width:0%;background:linear-gradient(90deg,#8e1a0e,#c0392b);}
.loading-text{margin-top:.8rem;font-size:.65rem;color:#333;letter-spacing:.25em;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}

/* AUTH */
#authScreen{background:radial-gradient(ellipse at center,#0a0005 0%,#000 100%);}
.auth-box{background:#0a0a0a;border:1px solid #1a1a1a;padding:clamp(1rem,4vw,2rem);width:min(360px,92vw);box-shadow:0 0 80px rgba(192,57,43,.08);}
.auth-title{font-family:'Creepster',cursive;font-size:clamp(1.4rem,5vw,1.8rem);color:#c0392b;text-align:center;margin-bottom:1.2rem;letter-spacing:.15em;}
.auth-tabs{display:flex;margin-bottom:1.2rem;border-bottom:1px solid #1a1a1a;}
.auth-tab{flex:1;padding:.5rem;background:none;border:none;color:#444;cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:.85rem;letter-spacing:.1em;transition:color .2s;}
.auth-tab.active{color:#c0392b;border-bottom:1px solid #c0392b;}
.auth-input{width:100%;background:#050505;border:1px solid #1a1a1a;color:#e0e0e0;padding:.7rem .9rem;margin-bottom:.8rem;font-family:'Share Tech Mono',monospace;font-size:.85rem;outline:none;transition:border-color .2s;}
.auth-input:focus{border-color:#c0392b;}
.auth-btn{width:100%;padding:.8rem;background:#c0392b;border:none;color:#fff;font-family:'Creepster',cursive;font-size:1.1rem;letter-spacing:.15em;cursor:pointer;transition:background .2s;}
.auth-btn:hover,.auth-btn:active{background:#a93226;}
.auth-msg{font-size:.75rem;text-align:center;margin-top:.8rem;min-height:1rem;color:#e74c3c;}
.auth-ok{color:#27ae60;}

/* LOBBY */
#lobbyScreen{background:#000;}
.lobby-bg{position:absolute;inset:0;background:radial-gradient(ellipse at center,#0c0005 0%,#000 70%);}
.lobby-content{position:relative;z-index:1;text-align:center;width:100%;}
.lobby-title{font-family:'Creepster',cursive;font-size:clamp(2rem,8vw,5rem);color:#c0392b;text-shadow:0 0 60px #c0392b,0 0 120px rgba(192,57,43,.4);margin-bottom:.3rem;letter-spacing:.15em;animation:pulse 3s ease-in-out infinite;}
.lobby-sub{font-size:clamp(.5rem,1.8vw,.7rem);color:#333;letter-spacing:.4em;margin-bottom:2rem;}
@keyframes pulse{0%,100%{text-shadow:0 0 60px #c0392b,0 0 120px rgba(192,57,43,.4);}50%{text-shadow:0 0 90px #c0392b,0 0 180px rgba(192,57,43,.6),0 0 25px #ff9;}}
.lobby-menu{display:flex;flex-direction:column;gap:.6rem;align-items:center;}
.lobby-btn{width:min(230px,80vw);padding:.65rem 1.5rem;background:transparent;border:1px solid #222;color:#666;font-family:'Share Tech Mono',monospace;font-size:clamp(.7rem,2.5vw,.8rem);letter-spacing:.2em;cursor:pointer;transition:all .2s;}
.lobby-btn:hover,.lobby-btn.primary,.lobby-btn:active{border-color:#c0392b;color:#c0392b;}
.lobby-user{position:absolute;top:calc(env(safe-area-inset-top) + .5rem);right:1.5rem;font-size:.65rem;color:#222;letter-spacing:.1em;}
.lobby-user span{color:#444;}
.lobby-deaths{position:absolute;top:calc(env(safe-area-inset-top) + .5rem);left:1.5rem;font-size:.65rem;color:#333;letter-spacing:.1em;}
.lobby-deaths span{color:#c0392b;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GROUP LOBBY SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#groupLobbyScreen{background:#000;z-index:15;overflow-y:auto;}
.gl-wrap{width:min(580px,97vw);max-height:calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 1rem);overflow-y:auto;padding:.5rem;}
.gl-header{text-align:center;margin-bottom:1rem;}
.gl-title{font-family:'Creepster',cursive;font-size:clamp(1.6rem,5vw,2.2rem);color:#c0392b;letter-spacing:.2em;text-shadow:0 0 30px rgba(192,57,43,.5);}
.gl-subtitle{font-size:.58rem;color:#333;letter-spacing:.3em;margin-top:.2rem;}
.gl-room-badge{display:inline-flex;align-items:center;gap:.8rem;background:#0a0a0a;border:1px solid #1a1a1a;padding:.5rem 1rem;margin:.6rem auto;border-radius:2px;}
.gl-room-id{font-family:'Creepster',cursive;font-size:clamp(1.2rem,4vw,1.6rem);color:#f39c12;letter-spacing:.35em;}
.gl-room-pass{font-size:.6rem;color:#555;letter-spacing:.15em;}
.gl-copy-btn{background:none;border:1px solid #2a2a2a;color:#444;font-family:'Share Tech Mono',monospace;font-size:.55rem;padding:.25rem .5rem;cursor:pointer;letter-spacing:.1em;transition:all .2s;}
.gl-copy-btn:hover{border-color:#f39c12;color:#f39c12;}

/* Player cards in group lobby */
.gl-players-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin-bottom:.8rem;}
@media(max-width:400px){.gl-players-grid{grid-template-columns:1fr;}}
.gl-player-card{background:#080808;border:1px solid #111;padding:.7rem;position:relative;transition:border-color .3s;}
.gl-player-card.ready{border-color:#27ae60;}
.gl-player-card.host{border-color:#f39c12;}
.gl-player-card.empty{border-color:#0d0d0d;opacity:.4;}
.gl-player-avatar{width:48px;height:48px;border-radius:50%;display:block;margin:0 auto .4rem;}
.gl-player-name{font-size:.7rem;color:#aaa;text-align:center;letter-spacing:.1em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.gl-player-status{font-size:.52rem;text-align:center;margin-top:.2rem;letter-spacing:.1em;}
.gl-player-status.ready-s{color:#27ae60;}
.gl-player-status.waiting-s{color:#555;}
.gl-player-status.host-s{color:#f39c12;}
.gl-player-badge{position:absolute;top:.3rem;right:.3rem;font-size:.45rem;padding:.15rem .35rem;border:1px solid;letter-spacing:.1em;}
.gl-player-badge.host-badge{border-color:#f39c12;color:#f39c12;}
.gl-player-badge.you-badge{border-color:#3498db;color:#3498db;}
.gl-slot-empty{font-size:.55rem;color:#1a1a1a;text-align:center;margin-top:.4rem;letter-spacing:.15em;}

/* Lobby mini-canvas for avatar preview */
.gl-player-canvas{display:block;margin:0 auto .4rem;border-radius:50%;border:2px solid #1a1a1a;}

/* Action buttons in group lobby */
.gl-actions{display:flex;flex-direction:column;gap:.5rem;}
.gl-btn{width:100%;padding:.7rem;border:1px solid #c0392b;background:none;color:#c0392b;font-family:'Creepster',cursive;font-size:clamp(1rem,3vw,1.1rem);cursor:pointer;transition:all .2s;letter-spacing:.15em;}
.gl-btn:hover,.gl-btn:active{background:rgba(192,57,43,.12);}
.gl-btn.secondary{border-color:#333;color:#555;}
.gl-btn.secondary:hover{border-color:#555;color:#888;}
.gl-btn.green{border-color:#27ae60;color:#27ae60;}
.gl-btn.green:hover{background:rgba(39,174,96,.12);}
.gl-btn:disabled{opacity:.3;cursor:not-allowed;}
.gl-status-bar{font-size:.6rem;color:#555;text-align:center;letter-spacing:.12em;min-height:1.2rem;padding:.3rem;border-top:1px solid #0d0d0d;margin-top:.5rem;}
.gl-status-bar.online{color:#27ae60;}
.gl-countdown{font-family:'Creepster',cursive;font-size:2rem;color:#c0392b;text-align:center;display:none;animation:countPulse .5s ease-in-out infinite alternate;}
@keyframes countPulse{from{transform:scale(.95);opacity:.8;}to{transform:scale(1.05);opacity:1;}}

/* MULTIPLAYER CREATE/JOIN */
#multiScreen{background:#000;z-index:10;overflow-y:auto;}
.multi-box{background:#080808;border:1px solid #1a1a1a;padding:clamp(1rem,3vw,1.5rem);width:min(420px,95vw);max-height:calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 2rem);overflow-y:auto;}
.multi-title{font-family:'Creepster',cursive;font-size:clamp(1.2rem,4vw,1.5rem);color:#c0392b;margin-bottom:1rem;text-align:center;letter-spacing:.15em;}
.multi-section{margin-bottom:1rem;}
.multi-label{font-size:.62rem;color:#444;margin-bottom:.4rem;letter-spacing:.15em;}
.multi-input{width:100%;background:#050505;border:1px solid #1a1a1a;color:#e0e0e0;padding:.6rem .8rem;font-family:'Share Tech Mono',monospace;font-size:.82rem;outline:none;transition:border-color .2s;margin-bottom:.5rem;}
.multi-input:focus{border-color:#c0392b;}
.multi-btn{width:100%;padding:.65rem;border:1px solid #c0392b;background:none;color:#c0392b;font-family:'Creepster',cursive;font-size:clamp(.9rem,3vw,1rem);cursor:pointer;transition:all .2s;letter-spacing:.12em;margin-bottom:.4rem;}
.multi-btn:hover,.multi-btn:active{background:rgba(192,57,43,.12);}
.multi-btn.secondary{border-color:#333;color:#555;}
.multi-btn.secondary:hover,.multi-btn.secondary:active{border-color:#666;color:#888;}
.multi-msg{font-size:.7rem;color:#555;text-align:center;min-height:1rem;margin-top:.5rem;}
.multi-status-online{color:#27ae60;}

/* GUIDE SCREEN */
#guideScreen{background:#000;z-index:10;overflow-y:auto;}
.guide-scroll-box{background:#080808;border:1px solid #1a1a1a;padding:clamp(1rem,3vw,1.5rem);width:min(460px,95vw);max-height:calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 2rem);overflow-y:auto;}
.guide-screen-title{font-family:'Creepster',cursive;font-size:clamp(1.3rem,4vw,1.7rem);color:#c0392b;text-align:center;margin-bottom:1.2rem;letter-spacing:.15em;}
.guide-section{margin-bottom:1.2rem;border-left:2px solid #c0392b33;padding-left:.8rem;}
.guide-section-title{font-size:.62rem;color:#c0392b;letter-spacing:.2em;margin-bottom:.5rem;text-transform:uppercase;}
.guide-section-body{font-size:.62rem;color:#666;line-height:1.8;letter-spacing:.04em;}
.guide-section-body b{color:#aaa;}
.guide-section-body .step{display:flex;gap:.5rem;margin-bottom:.3rem;align-items:flex-start;}
.guide-section-body .step-num{color:#c0392b;font-size:.6rem;min-width:14px;margin-top:.05rem;}
.guide-tip{background:#0a0a0a;border:1px solid #c0392b22;padding:.5rem .7rem;margin-top:.5rem;font-size:.58rem;color:#555;line-height:1.7;}
.guide-tip b{color:#888;}

/* CUSTOMIZE */
#customScreen{background:#000;z-index:10;}
.custom-box{background:#080808;border:1px solid #1a1a1a;padding:clamp(1rem,3vw,1.5rem);width:min(400px,95vw);max-height:calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 2rem);overflow-y:auto;}
.custom-title{font-family:'Creepster',cursive;font-size:clamp(1.2rem,4vw,1.5rem);color:#c0392b;margin-bottom:.8rem;text-align:center;}
.color-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.8rem;}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .2s;}
.color-swatch.selected{border-color:#fff;}
.custom-label{font-size:.65rem;color:#444;margin-bottom:.3rem;letter-spacing:.1em;}
.custom-actions{display:flex;gap:.8rem;margin-top:.8rem;}
.custom-actions button{flex:1;padding:.65rem;border:1px solid #222;background:none;color:#666;font-family:'Share Tech Mono',monospace;font-size:.75rem;cursor:pointer;transition:all .2s;letter-spacing:.1em;}
.custom-actions button.confirm{border-color:#c0392b;color:#c0392b;}

/* SETTINGS */
#settingsScreen{background:#000;z-index:10;}
.settings-box{background:#080808;border:1px solid #1a1a1a;padding:clamp(1rem,3vw,1.5rem);width:min(380px,92vw);}
.settings-title{font-family:'Creepster',cursive;font-size:clamp(1.2rem,4vw,1.5rem);color:#c0392b;margin-bottom:1.2rem;text-align:center;}
.setting-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem;padding-bottom:.8rem;border-bottom:1px solid #0d0d0d;}
.setting-label{font-size:clamp(.6rem,2vw,.7rem);color:#666;letter-spacing:.1em;}
input[type=range]{-webkit-appearance:none;background:#1a1a1a;height:3px;width:100px;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#c0392b;cursor:pointer;}
.toggle-btn{width:44px;height:22px;border-radius:11px;border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;}
.toggle-btn.on{background:#c0392b;}.toggle-btn.off{background:#222;}
.toggle-btn::after{content:'';position:absolute;top:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left .2s;}
.toggle-btn.on::after{left:25px;}.toggle-btn.off::after{left:3px;}
.back-btn{width:100%;padding:.7rem;border:1px solid #1a1a1a;background:none;color:#444;font-family:'Share Tech Mono',monospace;font-size:.75rem;cursor:pointer;margin-top:1rem;letter-spacing:.1em;}

/* GAME SCREEN */
#gameScreen{background:#000;padding:0;position:fixed;top:0;left:0;width:100vw;height:100vh;}
#gameCanvas{display:block;position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair;touch-action:none;}
#mpCanvas{position:absolute;top:0;left:0;pointer-events:none;z-index:9;width:100%;height:100%;}

/* HUD */
#hud{position:fixed;inset:0;pointer-events:none;z-index:5;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}
#dangerBar{position:absolute;top:0;left:0;width:100%;height:3px;transition:background .4s;}
#healthBar{position:absolute;top:calc(env(safe-area-inset-top) + 14px);left:calc(env(safe-area-inset-left) + 12px);display:flex;flex-direction:column;gap:3px;}
.hud-label{font-size:.5rem;color:#444;letter-spacing:.15em;}
.bar-bg{width:100px;height:6px;background:#0d0d0d;border:1px solid #1a1a1a;}
.bar-fill{height:100%;transition:width .3s;}
.hp-fill{background:linear-gradient(90deg,#7b241c,#e74c3c);}
.sta-fill{background:linear-gradient(90deg,#154360,#2980b9);}
#weaponHud{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 175px);right:calc(env(safe-area-inset-right) + 14px);text-align:right;}
.weapon-name{font-family:'Creepster',cursive;font-size:.95rem;color:#c0392b;text-shadow:0 0 12px rgba(192,57,43,.6);}
.ammo-count{font-size:.55rem;color:#444;letter-spacing:.15em;}
#pcControlsHint{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 8px);left:calc(env(safe-area-inset-left) + 12px);font-size:.43rem;color:#1e1e1e;letter-spacing:.05em;line-height:1.7;}
#weaponKeys{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 216px);right:calc(env(safe-area-inset-right) + 14px);text-align:right;font-size:.46rem;color:#222;letter-spacing:.07em;}
#abilityHud{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 175px);left:calc(env(safe-area-inset-left) + 12px);pointer-events:none;}
.ability-box{background:rgba(0,0,0,.85);border:1px solid #1a1a1a;padding:.4rem .6rem;min-width:110px;max-width:130px;}
.ability-name{font-family:'Creepster',cursive;font-size:.85rem;color:#f39c12;letter-spacing:.1em;}
.ability-desc{font-size:.45rem;color:#555;margin-top:.15rem;letter-spacing:.05em;line-height:1.35;}
.ability-key{font-size:.5rem;color:#f39c12;margin-top:.25rem;}
.ability-cd{height:3px;background:#1a1a1a;margin-top:.3rem;}
.ability-cd-fill{height:100%;background:#f39c12;transition:width .2s;}
#radarWrap{position:absolute;top:calc(env(safe-area-inset-top) + 14px);right:calc(env(safe-area-inset-right) + 12px);width:90px;height:90px;}
#radarCanvas{border-radius:50%;border:1px solid #1a1a1a;background:rgba(0,0,0,.92);display:block;}
.radar-label{font-size:.42rem;color:#1a1a1a;text-align:center;letter-spacing:.15em;margin-top:2px;}
#inventoryHud{position:absolute;top:calc(env(safe-area-inset-top) + 14px);left:50%;transform:translateX(-50%);display:flex;gap:2px;}
.inv-slot{width:34px;height:34px;border:1px solid #1a1a1a;background:#060606;display:flex;align-items:center;justify-content:center;font-size:.45rem;color:#333;flex-direction:column;gap:1px;cursor:pointer;transition:border-color .2s,background .2s,transform .1s;position:relative;}
.inv-slot.active{border-color:#c0392b;background:#110000;transform:scale(1.1);}
.inv-slot.has-item{color:#999;}
.inv-slot:hover{border-color:#444;}
.inv-icon{font-size:.85rem;line-height:1;}
.inv-slot .inv-num{font-size:.4rem;color:#333;position:absolute;margin-top:22px;}
#notif{position:absolute;top:calc(env(safe-area-inset-top) + 58px);left:50%;transform:translateX(-50%);text-align:center;pointer-events:none;min-width:180px;max-width:60vw;z-index:15;}
.notif-text{font-family:'Creepster',cursive;font-size:clamp(.9rem,3vw,1.1rem);color:#c0392b;text-shadow:0 0 16px currentColor;opacity:0;transition:opacity .4s;letter-spacing:.12em;background:rgba(0,0,0,.7);padding:.2rem .6rem;border:1px solid rgba(192,57,43,.3);}
.notif-sub{font-size:.55rem;color:#555;letter-spacing:.15em;margin-top:.2rem;opacity:0;transition:opacity .4s;max-width:50vw;word-break:break-word;}
#directionArrow{position:fixed;top:calc(env(safe-area-inset-top) + 120px);right:calc(env(safe-area-inset-right) + 12px);z-index:35;display:none;pointer-events:none;text-align:center;}
#directionArrow .da-inner{background:rgba(0,0,0,.88);border:1px solid #27ae6066;padding:.5rem .7rem;display:flex;flex-direction:column;align-items:center;gap:.3rem;}
#directionArrow .da-title{font-family:'Creepster',cursive;font-size:.75rem;color:#27ae60;letter-spacing:.15em;}
#directionArrow .da-arrow{font-size:1.8rem;color:#27ae60;text-shadow:0 0 15px #27ae60;animation:arrowPulse .6s ease-in-out infinite alternate;}
#directionArrow .da-dist{font-size:.5rem;color:#555;letter-spacing:.1em;}
#directionArrow .da-obj{font-size:.55rem;color:#27ae60;letter-spacing:.08em;max-width:100px;word-break:break-word;}
@keyframes arrowPulse{from{transform:scale(.9);opacity:.7;}to{transform:scale(1.1);opacity:1;}}

/* DEATH COUNTER HUD */
#deathCounter{position:absolute;top:calc(env(safe-area-inset-top) + 14px);left:50%;transform:translateX(-50%);margin-top:40px;display:flex;gap:4px;align-items:center;pointer-events:none;}
.death-pip{width:12px;height:12px;border-radius:50%;border:1px solid #333;background:#0a0a0a;transition:all .3s;}
.death-pip.used{background:#c0392b;border-color:#e74c3c;box-shadow:0 0 8px #c0392b;}
.death-pip.last{background:#ff0000;border-color:#ff0000;box-shadow:0 0 14px #ff0000;animation:lastPipPulse 1s infinite alternate;}
@keyframes lastPipPulse{from{box-shadow:0 0 8px #ff0000;}to{box-shadow:0 0 20px #ff0000,0 0 40px rgba(255,0,0,.4);}}

/* BOSS WARNING */
#bossWarning{position:fixed;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0);pointer-events:none;transition:background 1s;}
#bossWarning.show{background:rgba(80,0,0,.7);}
.boss-warn-title{font-family:'Creepster',cursive;font-size:clamp(2rem,8vw,5rem);color:#ff0000;text-shadow:0 0 60px #ff0000,0 0 120px #ff0000;letter-spacing:.2em;opacity:0;transform:scale(.3);transition:all .8s cubic-bezier(.34,1.56,.64,1);}
#bossWarning.show .boss-warn-title{opacity:1;transform:scale(1);}
.boss-warn-sub{font-size:clamp(.6rem,2vw,1rem);color:#ff6666;letter-spacing:.35em;margin-top:.8rem;opacity:0;transition:opacity 1s .4s;text-align:center;}
#bossWarning.show .boss-warn-sub{opacity:1;}
.boss-warn-name{font-family:'Creepster',cursive;font-size:clamp(1.2rem,4vw,2.5rem);color:#ff4444;letter-spacing:.2em;margin-top:.5rem;opacity:0;transition:opacity 1s .7s;text-shadow:0 0 40px rgba(255,0,0,.8);}
#bossWarning.show .boss-warn-name{opacity:1;}

/* MAP PANEL */
#mapPanel{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 175px);left:calc(env(safe-area-inset-left) + 12px);pointer-events:none;display:none;}
#mapPiecesCanvas{border:1px solid #1a1a1a;background:rgba(0,0,0,.85);display:block;}
.map-label{font-size:.42rem;color:#333;letter-spacing:.12em;margin-bottom:2px;}

/* GUIDE PANEL */
#guidePanel{position:fixed;bottom:calc(env(safe-area-inset-bottom) + 170px);left:50%;transform:translateX(-50%);z-index:20;pointer-events:none;width:min(300px,85vw);display:flex;flex-direction:column;align-items:center;gap:.3rem;}
.guide-box{background:rgba(0,0,0,.93);border:1px solid #c0392b44;border-left:3px solid #c0392b;padding:.45rem .65rem;opacity:0;transition:opacity .4s;width:100%;}
.guide-box.visible{opacity:1;}
.guide-title{font-size:.5rem;color:#c0392b;letter-spacing:.2em;margin-bottom:.2rem;text-transform:uppercase;}
.guide-msg{font-size:.58rem;color:#777;line-height:1.5;letter-spacing:.03em;}

/* QUEST TRACKER */
#questTracker{position:absolute;top:calc(env(safe-area-inset-top) + 115px);left:calc(env(safe-area-inset-left) + 12px);pointer-events:none;min-width:130px;max-width:160px;}
.quest-box{background:rgba(0,0,0,.88);border:1px solid #1a1a1a;border-left:2px solid #f39c12;padding:.35rem .5rem;}
.quest-label{font-size:.48rem;color:#f39c12;letter-spacing:.18em;margin-bottom:.3rem;}
.quest-step{font-size:.52rem;color:#555;letter-spacing:.03em;line-height:1.55;display:flex;gap:.3rem;align-items:flex-start;}
.quest-step.done{color:#333;text-decoration:line-through;}
.quest-step.active{color:#aaa;}
.quest-step .qs-icon{flex-shrink:0;margin-top:.05rem;}

/* KEY TRACKER */
#keyTracker{position:absolute;top:calc(env(safe-area-inset-top) + 240px);right:calc(env(safe-area-inset-right) + 12px);display:flex;flex-direction:column;gap:2px;}
.key-slot{width:90px;height:18px;border:1px solid #1a1a1a;background:#060606;display:flex;align-items:center;gap:4px;padding:0 4px;font-size:.45rem;color:#2a2a2a;}
.key-slot.found{border-color:#f39c12;color:#f39c12;}
.key-slot .ks-icon{font-size:.7rem;}

/* CREATURE FLASH */
#creatureFlash{position:fixed;inset:0;z-index:8;pointer-events:none;opacity:0;background:radial-gradient(ellipse at center,rgba(200,0,0,0.08) 0%,transparent 70%);transition:opacity .3s;}
#creatureFlash.active{opacity:1;}

/* ACHIEVEMENT WIPE OVERLAY */
#achievementWipe{position:fixed;inset:0;z-index:100;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0);padding:2rem;}
#achievementWipe.show{display:flex;animation:wipeIn 1s ease forwards;}
@keyframes wipeIn{from{background:rgba(0,0,0,0);}to{background:rgba(0,0,0,.98);}}
.aw-skull{font-size:5rem;animation:skullRattle 0.3s ease-in-out infinite alternate;margin-bottom:1rem;}
@keyframes skullRattle{from{transform:rotate(-8deg) scale(.95);}to{transform:rotate(8deg) scale(1.05);}}
.aw-title{font-family:'Creepster',cursive;font-size:clamp(2rem,8vw,4rem);color:#ff0000;letter-spacing:.25em;text-shadow:0 0 60px #ff0000,0 0 120px rgba(255,0,0,.5);text-align:center;margin-bottom:.5rem;}
.aw-sub{font-size:clamp(.65rem,2vw,.85rem);color:#555;letter-spacing:.15em;text-align:center;line-height:2;max-width:380px;margin-bottom:2rem;}
.aw-progress{width:min(300px,80vw);height:3px;background:#111;border:1px solid #222;margin-bottom:.5rem;}
.aw-progress-fill{height:100%;background:#ff0000;width:0%;transition:width 3s linear;}
.aw-timer{font-size:.65rem;color:#333;letter-spacing:.2em;}

/* MP CHAT */
#mpChat{position:fixed;bottom:calc(env(safe-area-inset-bottom) + 170px);left:calc(env(safe-area-inset-left) + 12px);z-index:22;pointer-events:none;display:flex;flex-direction:column;gap:2px;max-width:200px;}
.mp-chat-msg{font-size:.55rem;color:#888;background:rgba(0,0,0,.8);border:1px solid #1a1a1a;padding:.2rem .4rem;letter-spacing:.04em;opacity:1;transition:opacity 1s;}
.mp-chat-msg.fade{opacity:0;}
.mp-chat-msg b{color:#3498db;}

/* JOYSTICK */
#joystickZone{position:fixed;bottom:0;left:0;width:45%;height:42%;z-index:6;pointer-events:all;padding-bottom:env(safe-area-inset-bottom);}
#joystickBase{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 22px);left:22px;width:104px;height:104px;border-radius:50%;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);}
#joystickKnob{position:absolute;width:46px;height:46px;border-radius:50%;background:rgba(192,57,43,.3);border:2px solid rgba(192,57,43,.55);top:50%;left:50%;transform:translate(-50%,-50%);}

/* ACTION ZONE */
#actionZone{position:fixed;bottom:0;right:0;width:55%;height:42%;z-index:6;pointer-events:none;padding-bottom:env(safe-area-inset-bottom);padding-right:env(safe-area-inset-right);}
#fireBtn{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 22px);right:calc(env(safe-area-inset-right) + 18px);width:70px;height:70px;border-radius:50%;background:rgba(192,57,43,.2);border:2px solid rgba(192,57,43,.45);display:flex;align-items:center;justify-content:center;font-family:'Creepster',cursive;font-size:1rem;color:rgba(192,57,43,.9);pointer-events:all;-webkit-tap-highlight-color:transparent;letter-spacing:.05em;}
#reloadBtn{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 102px);right:calc(env(safe-area-inset-right) + 22px);width:48px;height:48px;border-radius:50%;background:rgba(35,35,35,.55);border:1px solid #2a2a2a;display:flex;align-items:center;justify-content:center;font-size:.48rem;color:#4a4a4a;pointer-events:all;-webkit-tap-highlight-color:transparent;font-family:'Share Tech Mono',monospace;}
#weaponPrevBtn{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 28px);right:calc(env(safe-area-inset-right) + 104px);width:44px;height:44px;border-radius:50%;background:rgba(25,25,25,.5);border:1px solid #1e1e1e;display:flex;align-items:center;justify-content:center;font-size:.85rem;color:#3a3a3a;pointer-events:all;-webkit-tap-highlight-color:transparent;}
#weaponNextBtn{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 78px);right:calc(env(safe-area-inset-right) + 96px);width:44px;height:44px;border-radius:50%;background:rgba(25,25,25,.5);border:1px solid #1e1e1e;display:flex;align-items:center;justify-content:center;font-size:.85rem;color:#3a3a3a;pointer-events:all;-webkit-tap-highlight-color:transparent;}
#abilityBtn{position:absolute;bottom:calc(env(safe-area-inset-bottom) + 162px);right:calc(env(safe-area-inset-right) + 22px);width:48px;height:48px;border-radius:50%;background:rgba(243,156,18,.15);border:2px solid rgba(243,156,18,.4);display:flex;align-items:center;justify-content:center;font-size:1rem;pointer-events:all;-webkit-tap-highlight-color:transparent;flex-direction:column;gap:0;}
#abilityBtnLabel{font-size:.38rem;color:#f39c12;font-family:'Share Tech Mono',monospace;letter-spacing:.04em;}
#pauseBtn{position:absolute;top:calc(env(safe-area-inset-top) + 8px);left:50%;transform:translateX(-50%);font-size:.5rem;color:#2a2a2a;background:rgba(0,0,0,.6);border:1px solid #111;padding:.25rem .7rem;cursor:pointer;pointer-events:all;font-family:'Share Tech Mono',monospace;letter-spacing:.15em;z-index:7;}

/* OVERLAYS */
#overlayScreen{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:20;display:none;flex-direction:column;align-items:center;justify-content:center;transition:background .8s;padding:1rem;}
#overlayScreen.visible{display:flex;}
#overlayScreen.dark{background:rgba(0,0,0,.94);}
.overlay-title{font-family:'Creepster',cursive;font-size:clamp(1.8rem,7vw,3.5rem);letter-spacing:.15em;margin-bottom:.8rem;}
.overlay-msg{font-size:clamp(.65rem,2vw,.75rem);color:#555;letter-spacing:.08em;max-width:380px;text-align:center;line-height:1.75;margin-bottom:1.5rem;white-space:pre-line;}
.overlay-btns{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;}
.overlay-btn{padding:.6rem 1.2rem;border:1px solid #1a1a1a;background:none;color:#555;font-family:'Share Tech Mono',monospace;font-size:.75rem;cursor:pointer;letter-spacing:.15em;transition:all .2s;}
.overlay-btn.danger{border-color:#c0392b;color:#c0392b;}
.overlay-btn:hover,.overlay-btn:active{background:#080808;}

#lockedRoomMsg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:25;display:none;flex-direction:column;align-items:center;gap:.8rem;background:rgba(0,0,0,.95);border:1px solid #c0392b44;padding:1.5rem;max-width:300px;text-align:center;width:90vw;}
#lockedRoomMsg.show{display:flex;}
.lrm-title{font-family:'Creepster',cursive;font-size:1.6rem;color:#c0392b;letter-spacing:.15em;}
.lrm-msg{font-size:.65rem;color:#555;line-height:1.7;letter-spacing:.04em;}
.lrm-close{padding:.5rem 1.5rem;border:1px solid #c0392b44;background:none;color:#c0392b;font-family:'Share Tech Mono',monospace;font-size:.7rem;cursor:pointer;letter-spacing:.15em;}

.inv-slot.flash{animation:slotFlash .15s ease;}
@keyframes slotFlash{0%{background:#2a0000;}100%{background:#110000;}}

/* MP teammate nametag always visible */
.mp-name-tag{pointer-events:none;position:absolute;z-index:10;}
</style>
</head>
<body>
<div id="screens">
  <!-- LOADING -->
  <div id="loadingScreen" class="active">
    <div class="logo-wrap">
      <div class="logo-title">THE DEATH LOOP</div>
      <div class="logo-sub">YOU WERE NEVER MEANT TO RETURN</div>
      <div class="loading-bar-wrap"><div class="loading-bar" id="loadBar"></div></div>
      <div class="loading-text" id="loadText">INITIALIZING...</div>
    </div>
  </div>

  <!-- AUTH -->
  <div id="authScreen">
    <div class="auth-box">
      <div class="auth-title">‚ò† ACCESS DENIED ‚ò†</div>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('login')">LOGIN</button>
        <button class="auth-tab" onclick="switchTab('register')">REGISTER</button>
      </div>
      <input class="auth-input" id="authId" type="text" placeholder="USER ID" autocomplete="new-password" spellcheck="false">
      <input class="auth-input" id="authPass" type="password" placeholder="PASSWORD" autocomplete="new-password">
      <button class="auth-btn" id="authSubmitBtn" onclick="handleAuth()">ENTER</button>
      <div class="auth-msg" id="authMsg"></div>
    </div>
  </div>

  <!-- LOBBY -->
  <div id="lobbyScreen">
    <div class="lobby-bg"></div>
    <div class="lobby-user">SURVIVOR: <span id="lobbyUser"></span></div>
    <div class="lobby-deaths" id="lobbyDeaths">LIVES: <span id="lobbyDeathCount">‚óè‚óè‚óè</span></div>
    <div class="lobby-content">
      <div class="lobby-title">THE FORGOTTEN LAND</div>
      <div class="lobby-sub">CHAPTER I ¬∑ THE DARK ARRIVAL</div>
      <div class="lobby-menu">
        <button class="lobby-btn primary" onclick="startGame(false)">‚ñ∂ RESUME GAME</button>
        <button class="lobby-btn" onclick="startGame(true)">‚Ü∫ RESTART</button>
        <button class="lobby-btn" onclick="showScreen('multiScreen')">üë• MULTIPLAYER</button>
        <button class="lobby-btn" onclick="showScreen('guideScreen')">üìñ HOW TO PLAY</button>
        <button class="lobby-btn" onclick="showScreen('customScreen')">‚ú¶ CUSTOMIZE</button>
        <button class="lobby-btn" onclick="showScreen('settingsScreen')">‚öô SETTINGS</button>
        <button class="lobby-btn" onclick="logout()">‚èè LOGOUT</button>
      </div>
    </div>
  </div>

  <!-- MULTIPLAYER CREATE/JOIN -->
  <div id="multiScreen">
    <div class="multi-box">
      <div class="multi-title">üë• MULTIPLAYER</div>
      <div class="multi-section">
        <div class="multi-label">HOST ‚Äî CREATE A ROOM (UP TO 4 PLAYERS)</div>
        <button class="multi-btn" onclick="createRoom()">‚äï CREATE ROOM & ENTER LOBBY</button>
      </div>
      <div class="multi-section">
        <div class="multi-label">JOIN A ROOM</div>
        <input class="multi-input" id="joinRoomId" placeholder="ROOM ID (e.g. DARK-1234)" spellcheck="false" autocomplete="off">
        <input class="multi-input" id="joinRoomPass" type="password" placeholder="ROOM PASSWORD" autocomplete="off">
        <button class="multi-btn" onclick="joinRoom()">‚äû JOIN ROOM</button>
      </div>
      <div class="multi-msg" id="multiMsg"></div>
      <button class="multi-btn secondary" style="margin-top:.5rem;" onclick="showScreen('lobbyScreen')">‚Üê BACK</button>
    </div>
  </div>

  <!-- GROUP LOBBY SCREEN -->
  <div id="groupLobbyScreen">
    <div class="gl-wrap">
      <div class="gl-header">
        <div class="gl-title">‚ò† SURVIVOR GROUP ‚ò†</div>
        <div class="gl-subtitle">WAITING FOR PLAYERS TO JOIN</div>
        <div class="gl-room-badge">
          <div>
            <div style="font-size:.5rem;color:#444;letter-spacing:.2em;margin-bottom:.1rem;">ROOM ID</div>
            <div class="gl-room-id" id="glRoomId">DARK-0000</div>
          </div>
          <div>
            <div style="font-size:.5rem;color:#444;letter-spacing:.2em;margin-bottom:.1rem;">PASSWORD</div>
            <div class="gl-room-pass" id="glRoomPass">‚Äî</div>
          </div>
          <button class="gl-copy-btn" onclick="copyRoomInfo()">üìã COPY</button>
        </div>
      </div>

      <!-- 4 Player Cards -->
      <div class="gl-players-grid" id="glPlayersGrid">
        <!-- filled dynamically -->
      </div>

      <div class="gl-countdown" id="glCountdown">3</div>

      <div class="gl-actions">
        <button class="gl-btn green" id="glReadyBtn" onclick="toggleGroupReady()">‚úì MARK READY</button>
        <button class="gl-btn" id="glStartBtn" onclick="hostStartGame()" style="display:none;">‚ñ∂ START GAME</button>
        <button class="gl-btn secondary" onclick="leaveGroupLobby()">‚Üê LEAVE LOBBY</button>
      </div>
      <div class="gl-status-bar" id="glStatus">Waiting for players...</div>
    </div>
  </div>

  <!-- HOW TO PLAY -->
  <div id="guideScreen">
    <div class="guide-scroll-box">
      <div class="guide-screen-title">üìñ HOW TO PLAY</div>
      <div class="guide-section">
        <div class="guide-section-title">üéØ GOAL</div>
        <div class="guide-section-body">Escape the Forgotten Land. Collect <b>4 boss keys</b> and use them at the <b>EXIT GATE</b> (green on radar). <div class="guide-tip">‚ö† You have <b>3 lives</b>. After 3 deaths, ALL progress and achievements are permanently wiped!</div></div>
      </div>
      <div class="guide-section">
        <div class="guide-section-title">üìã STEP-BY-STEP</div>
        <div class="guide-section-body">
          <div class="step"><span class="step-num">1.</span><span>Find <b>üó∫ Map Fragments</b> ‚Äî blue on radar. All 4 unlock boss rooms.</span></div>
          <div class="step"><span class="step-num">2.</span><span>Enter <b>BOSS ROOMS</b> (red on radar). Kill the boss, grab the <b>key</b>.</span></div>
          <div class="step"><span class="step-num">3.</span><span>Collect all <b>4 keys</b>. Key count shown top-right.</span></div>
          <div class="step"><span class="step-num">4.</span><span>Reach the <b>EXIT GATE</b> (green) ‚Äî escape!</span></div>
          <div class="guide-tip">Press <b>M</b> to toggle map. Objective arrow appears every 30s.</div>
        </div>
      </div>
      <div class="guide-section">
        <div class="guide-section-title">üë• MULTIPLAYER</div>
        <div class="guide-section-body">
          <div class="step"><span class="step-num">1.</span><span>Host clicks <b>CREATE ROOM</b> ‚Üí enters the <b>Group Lobby</b>.</span></div>
          <div class="step"><span class="step-num">2.</span><span>Share the Room ID + Password with friends.</span></div>
          <div class="step"><span class="step-num">3.</span><span>Friends join ‚Üí all mark <b>READY</b> ‚Üí host clicks <b>START GAME</b>.</span></div>
          <div class="step"><span class="step-num">4.</span><span>All players share the same world. <b>Teammates glow even in darkness!</b></span></div>
          <div class="guide-tip">Team mates are always visible even in the dark area and show on the map. Their name floats above their head at all times.</div>
        </div>
      </div>
      <div class="guide-section">
        <div class="guide-section-title">üíÄ 3-DEATH RULE</div>
        <div class="guide-section-body">
          You get <b>3 lives</b> per session. The pips top-center show remaining lives. On the 3rd death:
          <div class="guide-tip"><b>ALL achievements, keys, map fragments, and progress are permanently erased.</b> You are returned to the main menu. Start over.</div>
        </div>
      </div>
      <button class="back-btn" onclick="showScreen('lobbyScreen')">‚Üê BACK TO MENU</button>
    </div>
  </div>

  <!-- CUSTOMIZE -->
  <div id="customScreen">
    <div class="custom-box">
      <div class="custom-title">SURVIVOR PROFILE</div>
      <canvas id="customPreview" width="80" height="80" style="display:block;margin:0 auto .8rem;border-radius:50%;border:2px solid #1a1a1a;"></canvas>
      <div class="custom-label">SKIN TONE</div><div class="color-row" id="skinColors"></div>
      <div class="custom-label">SHIRT COLOR</div><div class="color-row" id="shirtColors"></div>
      <div class="custom-label">HAIR COLOR</div><div class="color-row" id="hairColors"></div>
      <div class="custom-actions">
        <button onclick="showScreen('lobbyScreen')">BACK</button>
        <button class="confirm" onclick="saveCustom()">SAVE</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsScreen">
    <div class="settings-box">
      <div class="settings-title">SETTINGS</div>
      <div class="setting-row"><div class="setting-label">FLASHLIGHT RADIUS</div><input type="range" min="80" max="260" value="160" id="settingFlight" oninput="settings.flashlightRadius=+this.value"></div>
      <div class="setting-row"><div class="setting-label">SOUND EFFECTS</div><button class="toggle-btn on" id="toggleSound" onclick="toggleSetting('sound')"></button></div>
      <div class="setting-row"><div class="setting-label">SHOW RADAR</div><button class="toggle-btn on" id="toggleMinimap" onclick="toggleSetting('minimap')"></button></div>
      <div class="setting-row"><div class="setting-label">GUIDE SYSTEM</div><button class="toggle-btn on" id="toggleGuide" onclick="toggleSetting('guide')"></button></div>
      <div class="setting-row"><div class="setting-label">QUEST TRACKER</div><button class="toggle-btn on" id="toggleQuest" onclick="toggleSetting('questTracker')"></button></div>
      <div class="setting-row"><div class="setting-label">CREATURE REVEAL (30s)</div><button class="toggle-btn on" id="toggleCreatureReveal" onclick="toggleSetting('creatureReveal')"></button></div>
      <button class="back-btn" onclick="showScreen('lobbyScreen')">‚Üê BACK</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="gameScreen">
    <canvas id="gameCanvas"></canvas>
    <canvas id="mpCanvas"></canvas>
    <div id="hud">
      <div id="dangerBar"></div>
      <div id="healthBar">
        <div class="hud-label">HEALTH</div>
        <div class="bar-bg"><div class="bar-fill hp-fill" id="hpFill" style="width:100%"></div></div>
        <div class="hud-label" style="margin-top:3px">STAMINA</div>
        <div class="bar-bg"><div class="bar-fill sta-fill" id="staFill" style="width:100%"></div></div>
      </div>
      <div id="deathCounter">
        <div class="death-pip" id="dp0"></div>
        <div class="death-pip" id="dp1"></div>
        <div class="death-pip" id="dp2"></div>
      </div>
      <div id="inventoryHud">
        <div class="inv-slot active" id="inv0" onclick="setWeapon(0)"><span class="inv-icon">üî´</span><span>PISTOL</span><span class="inv-num">1</span></div>
        <div class="inv-slot" id="inv1" onclick="setWeapon(1)"><span class="inv-icon">üí•</span><span>SHOTGN</span><span class="inv-num">2</span></div>
        <div class="inv-slot" id="inv2" onclick="setWeapon(2)"><span class="inv-icon">üéØ</span><span>SNIPER</span><span class="inv-num">3</span></div>
        <div class="inv-slot" id="inv3" onclick="setWeapon(3)"><span class="inv-icon">‚Äî</span><span></span><span class="inv-num">4</span></div>
        <div class="inv-slot" id="inv4" onclick="setWeapon(4)"><span class="inv-icon">‚Äî</span><span></span><span class="inv-num">5</span></div>
      </div>
      <div id="radarWrap">
        <canvas id="radarCanvas" width="90" height="90"></canvas>
        <div class="radar-label">RADAR</div>
      </div>
      <div id="weaponHud">
        <div class="weapon-name" id="weaponName">PISTOL</div>
        <div class="ammo-count" id="ammoCount">12 / 72</div>
      </div>
      <div id="weaponKeys">[ 1-3 ] WEAPON &nbsp;[ Q ] ABILITY &nbsp;[ E/F ] CYCLE &nbsp;[ R ] RELOAD &nbsp;[ M ] MAP</div>
      <div id="abilityHud" style="display:none;">
        <div class="ability-box">
          <div class="ability-name" id="abilityName">‚Äî</div>
          <div class="ability-desc" id="abilityDesc"></div>
          <div class="ability-key">[ Q ] or ABILITY BTN</div>
          <div class="ability-cd"><div class="ability-cd-fill" id="abilityCdFill" style="width:100%"></div></div>
        </div>
      </div>
      <div id="questTracker"><div class="quest-box"><div class="quest-label">OBJECTIVES</div><div id="questSteps"></div></div></div>
      <div id="keyTracker"></div>
      <div id="mapPanel"><div class="map-label">MAP FRAGMENTS</div><canvas id="mapPiecesCanvas" width="110" height="110"></canvas></div>
      <div id="notif"><div class="notif-text" id="notifText"></div><div class="notif-sub" id="notifSub"></div></div>
      <div id="guidePanel"></div>
      <div id="mpChat"></div>
      <div id="pcControlsHint">WASD:MOVE | MOUSE:AIM | CLICK/SPACE:FIRE | 1/2/3:WPN | Q:ABILITY | R:RELOAD | E/F:CYCLE | M:MAP | ESC:PAUSE</div>
    </div>
    <div id="creatureFlash"></div>
    <div id="directionArrow">
      <div class="da-inner">
        <div class="da-title">OBJECTIVE</div>
        <div class="da-arrow" id="daArrow">‚Üë</div>
        <div class="da-obj" id="daObj">FIND MAP FRAGMENT</div>
        <div class="da-dist" id="daDist">‚Äî m away</div>
      </div>
    </div>
    <div id="joystickZone"><div id="joystickBase"><div id="joystickKnob"></div></div></div>
    <div id="actionZone">
      <div id="fireBtn">FIRE</div>
      <div id="reloadBtn">RELOAD</div>
      <div id="weaponPrevBtn">‚óÑ</div>
      <div id="weaponNextBtn">‚ñ∫</div>
      <div id="abilityBtn"><span style="font-size:1rem;" id="abilityBtnIcon">‚ö°</span><span id="abilityBtnLabel">ABILITY</span></div>
    </div>
    <button id="pauseBtn" onclick="pauseGame()">‚ùö‚ùö PAUSE</button>
  </div>
</div>

<!-- BOSS WARNING -->
<div id="bossWarning">
  <div class="boss-warn-title">‚ö† WARNING ‚ö†</div>
  <div class="boss-warn-sub">YOU ARE ENTERING A BOSS ROOM</div>
  <div class="boss-warn-name" id="bossWarnName">THE DEVOURER AWAITS</div>
</div>

<!-- LOCKED ROOM MSG -->
<div id="lockedRoomMsg">
  <div class="lrm-title">üîí LOCKED</div>
  <div class="lrm-msg" id="lockedRoomMsgText">This chamber is sealed.</div>
  <button class="lrm-close" onclick="closeLockedMsg()">UNDERSTOOD</button>
</div>

<!-- DEATH / WIN OVERLAY -->
<div id="overlayScreen">
  <div class="overlay-title" id="overlayTitle">YOU DIED</div>
  <div class="overlay-msg" id="overlayMsg"></div>
  <div class="overlay-btns" id="overlayBtns">
    <button class="overlay-btn danger" onclick="respawn()">RESPAWN</button>
    <button class="overlay-btn" onclick="toLobby()">MAIN MENU</button>
  </div>
</div>

<!-- ACHIEVEMENT WIPE SCREEN -->
<div id="achievementWipe">
  <div class="aw-skull">‚ò†</div>
  <div class="aw-title">ALL IS LOST</div>
  <div class="aw-sub">You have died 3 times.<br>The Forgotten Land has consumed you.<br><br>ALL ACHIEVEMENTS, KEYS AND PROGRESS<br>HAVE BEEN PERMANENTLY ERASED.</div>
  <div class="aw-progress"><div class="aw-progress-fill" id="awProgressFill"></div></div>
  <div class="aw-timer" id="awTimer">Returning to main menu...</div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL='https://ojhkxmlzrpyzqeaiblxx.supabase.co';
const SUPABASE_KEY='sb_publishable_WQC_wGsGjz9YYle8j0EQoA_2yUvbny7';
let sbClient=null;
window.addEventListener('load',()=>{
  try{
    const lib=window.supabase||window['supabase'];
    if(lib&&SUPABASE_URL&&!SUPABASE_URL.includes('YOUR')){
      sbClient=lib.createClient(SUPABASE_URL,SUPABASE_KEY,{realtime:{params:{eventsPerSecond:30}}});
    }
  }catch(e){console.warn('Supabase init failed, using localStorage fallback',e);}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DB LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB={
  _ls(k){try{return JSON.parse(localStorage.getItem('tfl_'+k)||'null');}catch(e){return null;}},
  _lsSet(k,v){try{localStorage.setItem('tfl_'+k,JSON.stringify(v));}catch(e){}},
  async getUser(uid){
    if(sbClient){try{const{data}=await sbClient.from('tfl_users').select('*').eq('user_id',uid).single();return data;}catch(e){}}
    return this._ls('u_'+uid);
  },
  async createUser(uid,pw){
    const u={user_id:uid,password:pw,game_state:null,customization:{skin:'#c8a882',shirt:'#8e1a0e',hair:'#2c1810'},death_count:0};
    if(sbClient){try{const{data,error}=await sbClient.from('tfl_users').insert(u).select().single();if(!error)return data;}catch(e){}}
    this._lsSet('u_'+uid,u);return u;
  },
  async saveState(uid,state){
    const clean={...state,bullets:[],particles:[]};
    if(sbClient){try{await sbClient.from('tfl_users').update({game_state:clean}).eq('user_id',uid);return;}catch(e){}}
    const u=this._ls('u_'+uid)||{};u.game_state=clean;this._lsSet('u_'+uid,u);
  },
  async saveDeathCount(uid,count){
    if(sbClient){try{await sbClient.from('tfl_users').update({death_count:count}).eq('user_id',uid);return;}catch(e){}}
    const u=this._ls('u_'+uid)||{};u.death_count=count;this._lsSet('u_'+uid,u);
  },
  async wipeProgress(uid){
    if(sbClient){try{await sbClient.from('tfl_users').update({game_state:null,death_count:0}).eq('user_id',uid);return;}catch(e){}}
    const u=this._ls('u_'+uid)||{};u.game_state=null;u.death_count=0;this._lsSet('u_'+uid,u);
  },
  async saveCustom(uid,c){
    if(sbClient){try{await sbClient.from('tfl_users').update({customization:c}).eq('user_id',uid);return;}catch(e){}}
    const u=this._ls('u_'+uid)||{};u.customization=c;this._lsSet('u_'+uid,u);
  },

  // ‚îÄ‚îÄ REALTIME MULTIPLAYER ‚îÄ‚îÄ
  mpChannel:null,
  async joinMpChannel(roomId,onMessage){
    if(this.mpChannel)try{await sbClient?.removeChannel(this.mpChannel);}catch(e){}
    if(!sbClient)return null;
    try{
      const ch=sbClient.channel('mp_'+roomId,{config:{broadcast:{self:false,ack:false}}});
      ch.on('broadcast',{event:'pos'},({payload})=>onMessage({type:'pos',...payload}));
      ch.on('broadcast',{event:'action'},({payload})=>onMessage({type:'action',...payload}));
      ch.on('broadcast',{event:'lobby'},({payload})=>onMessage({type:'lobby',...payload}));
      ch.on('broadcast',{event:'start'},({payload})=>onMessage({type:'start',...payload}));
      ch.on('broadcast',{event:'chat'},({payload})=>onMessage({type:'chat',...payload}));
      ch.on('broadcast',{event:'ready'},({payload})=>onMessage({type:'ready',...payload}));
      await ch.subscribe();
      this.mpChannel=ch;return ch;
    }catch(e){return null;}
  },
  async broadcast(event,payload){
    if(!this.mpChannel)return;
    try{await this.mpChannel.send({type:'broadcast',event,payload});}catch(e){}
  },
  async saveMpRoom(room){
    const data={...room,ts:Date.now()};
    if(sbClient){try{await sbClient.from('tfl_rooms').upsert({room_id:room.id,pass:room.pass,host:room.host,world_seed:room.worldSeed,players:room.players,started:room.started||false,ts:Date.now()});return;}catch(e){}}
    try{localStorage.setItem('tfl_mp_'+room.id,JSON.stringify(data));}catch(e){}
  },
  async loadMpRoom(id){
    if(sbClient){
      try{
        const{data}=await sbClient.from('tfl_rooms').select('*').eq('room_id',id).single();
        if(!data)return null;
        if(Date.now()-data.ts>300000)return null;
        return{id:data.room_id,pass:data.pass,host:data.host,worldSeed:data.world_seed,players:data.players||{},started:data.started};
      }catch(e){}
    }
    try{
      const d=localStorage.getItem('tfl_mp_'+id);if(!d)return null;
      const r=JSON.parse(d);if(Date.now()-r.ts>300000){localStorage.removeItem('tfl_mp_'+id);return null;}
      return r;
    }catch(e){return null;}
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MULTIPLAYER STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let multiRoom=null,isHost=false,isGroupReady=false,isMultiplayer=false;
const MP_COLORS=['#3498db','#2ecc71','#e67e22','#9b59b6'];
const MP_SPAWN={x:60,y:60};
const mpRemoteStates={};
const mpTargetStates={};
const MP_LERP=0.22;
let mpSyncTimer=0;
const MP_SYNC_MS=40;

function mpGenId(){return 'DARK-'+Math.floor(1000+Math.random()*9000);}
function mpGenPass(){return String(Math.floor(1000+Math.random()*9000));}

function getMpColor(idx){return MP_COLORS[idx%MP_COLORS.length];}

// ‚îÄ‚îÄ GROUP LOBBY ‚îÄ‚îÄ
async function createRoom(){
  document.getElementById('multiMsg').textContent='Creating room...';
  const id=mpGenId(),pass=mpGenPass();
  const myColor=custom.shirt||MP_COLORS[0];
  multiRoom={id,pass,host:currentUser,worldSeed:Math.floor(Math.random()*999999),players:{},started:false};
  multiRoom.players[currentUser]={
    x:MP_SPAWN.x,y:MP_SPAWN.y,angle:0,color:myColor,ready:true,hp:100,
    name:currentUser,skin:custom.skin,shirt:custom.shirt,hair:custom.hair,
    idx:0,ts:Date.now(),isHost:true
  };
  isHost=true;isGroupReady=true;
  await DB.saveMpRoom(multiRoom);
  await DB.joinMpChannel(id,handleMpMessage);
  startGroupLobbyPolling();
  openGroupLobby();
}

async function joinRoom(){
  const id=document.getElementById('joinRoomId').value.trim().toUpperCase();
  const pass=document.getElementById('joinRoomPass').value.trim();
  const msgEl=document.getElementById('multiMsg');
  if(!id||!pass){msgEl.textContent='Enter Room ID and Password';return;}
  msgEl.textContent='Connecting...';
  const room=await DB.loadMpRoom(id);
  if(!room){msgEl.textContent='Room not found.';return;}
  if(room.pass!==pass){msgEl.textContent='Wrong password.';return;}
  const playerCount=Object.keys(room.players||{}).length;
  if(playerCount>=4){msgEl.textContent='Room is full (4/4).';return;}
  if(room.started){msgEl.textContent='Game already in progress.';return;}
  multiRoom={...room};isHost=false;isGroupReady=false;
  const pIdx=playerCount;
  const myColor=getMpColor(pIdx);
  multiRoom.players[currentUser]={
    x:MP_SPAWN.x+pIdx*22,y:MP_SPAWN.y+pIdx*22,angle:0,color:myColor,ready:false,hp:100,
    name:currentUser,skin:custom.skin,shirt:custom.shirt,hair:custom.hair,
    idx:pIdx,ts:Date.now(),isHost:false
  };
  await DB.saveMpRoom(multiRoom);
  await DB.joinMpChannel(id,handleMpMessage);
  await DB.broadcast('lobby',{uid:currentUser,players:multiRoom.players,action:'join'});
  startGroupLobbyPolling();
  openGroupLobby();
}

function openGroupLobby(){
  document.getElementById('glRoomId').textContent=multiRoom.id;
  document.getElementById('glRoomPass').textContent=multiRoom.pass;
  document.getElementById('glStartBtn').style.display=isHost?'block':'none';
  document.getElementById('glReadyBtn').style.display=isHost?'none':'block';
  renderGroupLobbyPlayers();
  showScreen('groupLobbyScreen');
}

function renderGroupLobbyPlayers(){
  const grid=document.getElementById('glPlayersGrid');
  grid.innerHTML='';
  const players=Object.values(multiRoom?.players||{});
  const slots=4;
  for(let i=0;i<slots;i++){
    const card=document.createElement('div');
    const p=players[i];
    if(p){
      const isMe=p.name===currentUser;
      const col=p.color||'#c0392b';
      card.className='gl-player-card'+(p.ready?' ready':'')+(p.isHost?' host':'');
      // Canvas avatar
      const cvId='gl-cv-'+i;
      let badges='';
      if(p.isHost)badges+=`<div class="gl-player-badge host-badge">HOST</div>`;
      if(isMe)badges+=`<div class="gl-player-badge you-badge" style="top:${p.isHost?'1.4rem':'.3rem'}">YOU</div>`;
      card.innerHTML=`
        ${badges}
        <canvas id="${cvId}" class="gl-player-canvas" width="52" height="52" style="border-color:${col};"></canvas>
        <div class="gl-player-name" style="color:${col}">${p.name.substring(0,12)}</div>
        <div class="gl-player-status ${p.ready?'ready-s':p.isHost?'host-s':'waiting-s'}">${p.ready?'‚úì READY':p.isHost?'‚òÖ HOST':'WAITING...'}</div>
      `;
      grid.appendChild(card);
      // Draw avatar
      setTimeout(()=>{
        const cv=document.getElementById(cvId);if(!cv)return;
        const cx=cv.getContext('2d');drawPlayerAvatar(cx,26,26,p.skin||'#c8a882',p.shirt||col,p.hair||'#2c1810');
      },0);
    }else{
      card.className='gl-player-card empty';
      card.innerHTML=`<div class="gl-slot-empty" style="font-size:1.8rem;margin-top:5px">üë§</div><div class="gl-slot-empty">WAITING...</div>`;
      grid.appendChild(card);
    }
  }
  // Update status
  const readyCount=players.filter(p=>p.ready).length;
  const total=players.length;
  const allReady=readyCount===total&&total>=1;
  const statusEl=document.getElementById('glStatus');
  statusEl.className='gl-status-bar'+(allReady?' online':'');
  statusEl.textContent=allReady?`ALL ${total} PLAYERS READY ‚Äî HOST CAN START!`:`${readyCount}/${total} READY`;
  // Enable/disable start btn
  const startBtn=document.getElementById('glStartBtn');
  if(startBtn)startBtn.disabled=!allReady;
}

function drawPlayerAvatar(cx,px,py,skin,shirt,hair){
  cx.clearRect(0,0,52,52);
  cx.fillStyle=shirt;cx.beginPath();cx.ellipse(px,py+4,9,7,0,0,Math.PI*2);cx.fill();
  cx.fillStyle=skin;cx.beginPath();cx.arc(px,py-4,9,0,Math.PI*2);cx.fill();
  cx.fillStyle=hair;cx.beginPath();cx.arc(px,py-6,8,Math.PI+.2,-.2);cx.fill();
  cx.fillStyle='#fff';cx.beginPath();cx.arc(px+4,py-5,2,0,Math.PI*2);cx.fill();cx.beginPath();cx.arc(px-4,py-5,2,0,Math.PI*2);cx.fill();
  cx.fillStyle='#111';cx.beginPath();cx.arc(px+4,py-5,1,0,Math.PI*2);cx.fill();cx.beginPath();cx.arc(px-4,py-5,1,0,Math.PI*2);cx.fill();
}

async function toggleGroupReady(){
  isGroupReady=!isGroupReady;
  if(multiRoom?.players[currentUser])multiRoom.players[currentUser].ready=isGroupReady;
  await DB.saveMpRoom(multiRoom);
  await DB.broadcast('ready',{uid:currentUser,ready:isGroupReady});
  const btn=document.getElementById('glReadyBtn');
  btn.style.borderColor=isGroupReady?'#27ae60':'#c0392b';
  btn.style.color=isGroupReady?'#27ae60':'#c0392b';
  btn.textContent=isGroupReady?'‚úì READY ‚Äî WAITING FOR HOST':'‚úì MARK READY';
  renderGroupLobbyPlayers();
}

async function hostStartGame(){
  if(!isHost||!multiRoom)return;
  const players=Object.values(multiRoom.players);
  const allReady=players.every(p=>p.ready);
  if(!allReady){document.getElementById('glStatus').textContent='Not all players are ready!';return;}
  multiRoom.started=true;
  await DB.saveMpRoom(multiRoom);
  await DB.broadcast('start',{worldSeed:multiRoom.worldSeed,uid:currentUser});
  startCountdown(()=>launchMultiGame());
}

function startCountdown(cb){
  let n=3;const el=document.getElementById('glCountdown');
  document.getElementById('glActions')&&(document.getElementById('glActions').style.display='none');
  el.style.display='block';el.textContent=n;
  const iv=setInterval(()=>{n--;if(n<=0){clearInterval(iv);el.style.display='none';cb();}else{el.textContent=n;}},1000);
}

function handleMpMessage(msg){
  if(!msg||!multiRoom)return;

  if(msg.type==='pos'&&msg.uid!==currentUser){
    if(!multiRoom.players[msg.uid])multiRoom.players[msg.uid]={color:MP_COLORS[1],name:msg.uid};
    mpTargetStates[msg.uid]={...msg.data,ts:Date.now()};
    if(!mpRemoteStates[msg.uid])mpRemoteStates[msg.uid]={...msg.data};
    Object.assign(multiRoom.players[msg.uid],msg.data,{ts:Date.now()});
  }

  if(msg.type==='action'&&msg.uid!==currentUser){
    if(msg.action==='creature_killed'&&game){
      const cr=game.creatures.find(c=>c.id===msg.creatureId);
      if(cr&&!cr.dead){cr.dead=true;if(typeof spawnParticles==='function')spawnParticles(game,cr.x,cr.y,cr.color?.body||'#800',14);}
    }
    if(msg.action==='chat')addMpChat(msg.uid,msg.text);
  }

  if(msg.type==='lobby'){
    if(msg.uid!==currentUser){
      Object.entries(msg.players||{}).forEach(([uid,p])=>{
        if(!multiRoom.players[uid]||p.ts>=(multiRoom.players[uid]?.ts||0))
          multiRoom.players[uid]={...p,ts:Date.now()};
      });
    }
    if(document.getElementById('groupLobbyScreen').classList.contains('active'))renderGroupLobbyPlayers();
  }

  if(msg.type==='ready'&&msg.uid!==currentUser){
    if(multiRoom.players[msg.uid])multiRoom.players[msg.uid].ready=msg.ready;
    if(document.getElementById('groupLobbyScreen').classList.contains('active'))renderGroupLobbyPlayers();
  }

  if(msg.type==='start'&&!isHost){
    if(msg.worldSeed)multiRoom.worldSeed=msg.worldSeed;
    startCountdown(()=>launchMultiGame());
  }
}

function launchMultiGame(){
  isMultiplayer=true;
  if(window._mpPollInterval)clearInterval(window._mpPollInterval);
  startGame(true,multiRoom.worldSeed);
}

let _mpPollInterval=null;
function startGroupLobbyPolling(){
  if(_mpPollInterval)clearInterval(_mpPollInterval);
  _mpPollInterval=setInterval(async()=>{
    if(!multiRoom)return;
    const fresh=await DB.loadMpRoom(multiRoom.id);
    if(!fresh)return;
    Object.entries(fresh.players||{}).forEach(([uid,p])=>{
      if(uid!==currentUser)multiRoom.players[uid]={...multiRoom.players[uid],...p,ts:Date.now()};
    });
    if(document.getElementById('groupLobbyScreen').classList.contains('active'))renderGroupLobbyPlayers();
  },2500);
}

async function leaveGroupLobby(){
  if(_mpPollInterval)clearInterval(_mpPollInterval);
  if(sbClient&&DB.mpChannel)try{await sbClient.removeChannel(DB.mpChannel);}catch(e){}
  multiRoom=null;isHost=false;isMultiplayer=false;DB.mpChannel=null;
  showScreen('multiScreen');
}

function copyRoomInfo(){
  if(!multiRoom)return;
  const text=`THE FORGOTTEN LAND ROOM\nID: ${multiRoom.id}\nPassword: ${multiRoom.pass}`;
  navigator.clipboard?.writeText(text).catch(()=>{});
  const btn=document.querySelector('.gl-copy-btn');if(btn){btn.textContent='‚úì COPIED';setTimeout(()=>btn.textContent='üìã COPY',2000);}
}

// ‚îÄ‚îÄ Position sync ‚îÄ‚îÄ
async function syncMpPos(dt){
  if(!isMultiplayer||!multiRoom||!game)return;
  mpSyncTimer+=dt;if(mpSyncTimer<MP_SYNC_MS)return;mpSyncTimer=0;
  const myData={
    x:game.px,y:game.py,angle:game.angle,hp:game.hp,
    color:multiRoom.players[currentUser]?.color||'#c0392b',
    name:currentUser,skin:custom.skin,shirt:custom.shirt,hair:custom.hair,
    invisible:game.invisible,berserker:game.berserker>0,shielded:game.shielded>0,ts:Date.now()
  };
  multiRoom.players[currentUser]={...multiRoom.players[currentUser],...myData};
  await DB.broadcast('pos',{uid:currentUser,data:myData});
}

function interpolateMpStates(){
  if(!isMultiplayer)return;
  for(const uid in mpTargetStates){
    if(!mpRemoteStates[uid])mpRemoteStates[uid]={...mpTargetStates[uid]};
    const cur=mpRemoteStates[uid],tgt=mpTargetStates[uid];
    cur.x+=(tgt.x-cur.x)*MP_LERP;cur.y+=(tgt.y-cur.y)*MP_LERP;
    let da=tgt.angle-cur.angle;while(da>Math.PI)da-=Math.PI*2;while(da<-Math.PI)da+=Math.PI*2;
    cur.angle+=da*MP_LERP;
    cur.hp=tgt.hp;cur.color=tgt.color;cur.skin=tgt.skin;cur.shirt=tgt.shirt;cur.hair=tgt.hair;
    cur.invisible=tgt.invisible;cur.berserker=tgt.berserker;cur.shielded=tgt.shielded;cur.ts=tgt.ts;
    if(multiRoom?.players[uid])Object.assign(multiRoom.players[uid],cur);
  }
}

// ‚îÄ‚îÄ MP Chat ‚îÄ‚îÄ
const mpChatMessages=[];
function addMpChat(uid,text){
  const el=document.getElementById('mpChat');
  const msg=document.createElement('div');msg.className='mp-chat-msg';
  msg.innerHTML=`<b>${uid.substring(0,10)}:</b> ${text}`;
  el.appendChild(msg);mpChatMessages.push(msg);
  if(mpChatMessages.length>4)mpChatMessages.shift().remove();
  setTimeout(()=>{msg.classList.add('fade');setTimeout(()=>msg.remove(),1000);},5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MP CANVAS ‚Äî Teammates ALWAYS VISIBLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const mpCv=document.getElementById('mpCanvas');
const mpCtx=mpCv.getContext('2d');
function resizeMpCanvas(){mpCv.width=window.innerWidth;mpCv.height=window.innerHeight;}
window.addEventListener('resize',resizeMpCanvas);resizeMpCanvas();

function hexToRgba(hex,alpha){
  if(!hex||hex[0]!=='#')return`rgba(180,0,0,${alpha})`;
  const r=parseInt(hex.slice(1,3),16)||180;const g2=parseInt(hex.slice(3,5),16)||0;const b=parseInt(hex.slice(5,7),16)||0;
  return`rgba(${r},${g2},${b},${alpha})`;
}

function renderMpPlayers(g){
  mpCtx.clearRect(0,0,mpCv.width,mpCv.height);
  if(!isMultiplayer||!multiRoom||!g)return;
  interpolateMpStates();
  const camX=g.px-mpCv.width/2,camY=g.py-mpCv.height/2;
  const W=mpCv.width,H=mpCv.height;

  Object.entries(multiRoom.players).forEach(([uid,p])=>{
    if(uid===currentUser)return;
    // Use smoothed state
    const state=mpRemoteStates[uid]||p;
    if(!state)return;
    if(state.ts&&Date.now()-state.ts>8000)return;

    const sx=state.x-camX,sy=state.y-camY;
    const col=state.color||'#3498db';
    const skin=state.skin||'#c8a882';
    const shirt=state.shirt||col;
    const hair=state.hair||'#2c1810';

    mpCtx.save();

    // ‚òÖ ALWAYS VISIBLE GLOW ‚Äî even in dark ‚Äî draw through darkness
    // Large beacon glow so player is always locatable
    const beaconGrad=mpCtx.createRadialGradient(sx,sy,0,sx,sy,55);
    beaconGrad.addColorStop(0,hexToRgba(col,0.55));
    beaconGrad.addColorStop(0.5,hexToRgba(col,0.2));
    beaconGrad.addColorStop(1,'rgba(0,0,0,0)');
    mpCtx.fillStyle=beaconGrad;mpCtx.beginPath();mpCtx.arc(sx,sy,55,0,Math.PI*2);mpCtx.fill();

    if(state.invisible)mpCtx.globalAlpha=0.5;

    // Body
    mpCtx.fillStyle=shirt;mpCtx.beginPath();mpCtx.ellipse(sx,sy+3,9,7,0,0,Math.PI*2);mpCtx.fill();
    // Head
    mpCtx.fillStyle=skin;mpCtx.beginPath();mpCtx.arc(sx,sy-4,9,0,Math.PI*2);mpCtx.fill();
    // Hair
    mpCtx.fillStyle=hair;mpCtx.beginPath();mpCtx.arc(sx,sy-6,8,Math.PI+.2,-.2);mpCtx.fill();
    // Eyes
    const angle=state.angle||0;
    const ex=Math.cos(angle)*7,ey=Math.sin(angle)*7;
    mpCtx.fillStyle='#fff';
    [1,-1].forEach(s=>{mpCtx.beginPath();mpCtx.arc(sx+ex+Math.cos(angle+Math.PI/2)*2.5*s,sy-4+ey+Math.sin(angle+Math.PI/2)*2.5*s,1.5,0,Math.PI*2);mpCtx.fill();});
    // Gun line
    mpCtx.strokeStyle=col;mpCtx.lineWidth=2;mpCtx.shadowBlur=10;mpCtx.shadowColor=col;
    mpCtx.beginPath();mpCtx.moveTo(sx,sy);mpCtx.lineTo(sx+Math.cos(angle)*20,sy+Math.sin(angle)*20);mpCtx.stroke();
    mpCtx.shadowBlur=0;

    // Status rings
    if(state.shielded){mpCtx.strokeStyle='rgba(41,128,185,0.8)';mpCtx.lineWidth=2.5;mpCtx.shadowBlur=14;mpCtx.shadowColor='#2980b9';mpCtx.beginPath();mpCtx.arc(sx,sy,22,0,Math.PI*2);mpCtx.stroke();mpCtx.shadowBlur=0;}
    if(state.berserker){mpCtx.strokeStyle='rgba(231,76,60,0.8)';mpCtx.lineWidth=2;mpCtx.shadowBlur=12;mpCtx.shadowColor='#e74c3c';mpCtx.beginPath();mpCtx.arc(sx,sy,24,0,Math.PI*2);mpCtx.stroke();mpCtx.shadowBlur=0;}

    mpCtx.globalAlpha=1;

    // ‚òÖ NAME TAG ‚Äî always visible, bright, contrasted
    const tag=uid.substring(0,10).toUpperCase();
    mpCtx.font='bold 10px Share Tech Mono,monospace';
    const tw=mpCtx.measureText(tag).width;
    // Background box
    mpCtx.fillStyle='rgba(0,0,0,0.9)';
    const bx=sx-tw/2-5,by=sy-32,bw=tw+10,bh=15;
    mpCtx.fillRect(bx,by,bw,bh);
    // Colored border
    mpCtx.strokeStyle=col;mpCtx.lineWidth=1.5;
    mpCtx.shadowBlur=8;mpCtx.shadowColor=col;
    mpCtx.strokeRect(bx,by,bw,bh);
    // Name text
    mpCtx.fillStyle='#ffffff';mpCtx.shadowBlur=6;mpCtx.shadowColor=col;
    mpCtx.textAlign='center';mpCtx.fillText(tag,sx,sy-21);
    mpCtx.shadowBlur=0;

    // HP bar
    const hpPct=Math.max(0,Math.min(1,(state.hp||100)/100));
    mpCtx.fillStyle='rgba(0,0,0,0.7)';mpCtx.fillRect(sx-22,sy-12,44,5);
    mpCtx.fillStyle=hpPct>.5?'#27ae60':hpPct>.25?'#f39c12':'#e74c3c';
    mpCtx.fillRect(sx-22,sy-12,44*hpPct,5);

    // Arrow indicator if off-screen edge
    if(sx<-30||sx>W+30||sy<-30||sy>H+30){
      // Show edge indicator
      const ex2=Math.max(20,Math.min(W-20,sx)),ey2=Math.max(20,Math.min(H-20,sy));
      const ang=Math.atan2(sy-H/2,sx-W/2);
      mpCtx.save();mpCtx.translate(ex2,ey2);mpCtx.rotate(ang);
      mpCtx.fillStyle=col;mpCtx.shadowBlur=12;mpCtx.shadowColor=col;
      mpCtx.beginPath();mpCtx.moveTo(12,0);mpCtx.lineTo(-6,-7);mpCtx.lineTo(-6,7);mpCtx.closePath();mpCtx.fill();
      mpCtx.shadowBlur=0;
      // Mini name at edge
      mpCtx.rotate(-ang);mpCtx.font='8px Share Tech Mono';mpCtx.fillStyle=col;mpCtx.textAlign='center';
      mpCtx.fillText(uid.substring(0,6),0,22);
      mpCtx.restore();
    }

    mpCtx.restore();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEB AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx=null;
const settings={flashlightRadius:160,minimap:true,guide:true,sound:true,creatureReveal:true,questTracker:true};
function getAudio(){if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}return audioCtx;}
function playTone(freq,type,dur,vol,detune=0,delayS=0){if(!settings.sound)return;const ac=getAudio();if(!ac)return;setTimeout(()=>{try{const g2=ac.createGain(),o=ac.createOscillator();o.type=type;o.frequency.value=freq;o.detune.value=detune;g2.gain.setValueAtTime(vol,ac.currentTime);g2.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);o.connect(g2);g2.connect(ac.destination);o.start();o.stop(ac.currentTime+dur);}catch(e){}},delayS*1000);}
function playNoise(dur,vol,hipass=200){if(!settings.sound)return;const ac=getAudio();if(!ac)return;try{const buf=ac.createBuffer(1,ac.sampleRate*dur,ac.sampleRate);const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const src=ac.createBufferSource();src.buffer=buf;const f=ac.createBiquadFilter();f.type='highpass';f.frequency.value=hipass;const g2=ac.createGain();g2.gain.setValueAtTime(vol,ac.currentTime);g2.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);src.connect(f);f.connect(g2);g2.connect(ac.destination);src.start();}catch(e){}}
const SND={
  shoot(w){if(w===0){playTone(180,'sawtooth',.12,.4);playNoise(.07,.3,800);}else if(w===1){playTone(80,'sawtooth',.2,.6);playNoise(.15,.5,200);for(let i=0;i<5;i++)playTone(120+i*30,'square',.08,.2,0,i*.02);}else{playTone(320,'sawtooth',.08,.5);playNoise(.04,.4,1200);playTone(160,'triangle',.15,.3,0,.03);}},
  reload(){playTone(400,'square',.05,.2);playTone(600,'square',.05,.2,0,.08);playTone(350,'square',.1,.15,0,.14);},
  pickup(){playTone(440,'sine',.12,.4);playTone(660,'sine',.12,.4,0,.1);},
  keyFound(){for(let i=0;i<5;i++)playTone(330+i*110,'sine',.2,.5,0,i*.08);},
  hurt(){playTone(100,'sawtooth',.15,.7);playNoise(.2,.5,50);},
  death(){for(let i=0;i<8;i++)playTone(200-i*18,'sawtooth',.25,.5,0,i*.06);playNoise(.5,.6,30);},
  finalDeath(){for(let i=0;i<12;i++)playTone(300-i*20,'sawtooth',.5,.8,0,i*.08);playNoise(1.2,.8,20);},
  creatureGroan(type){const freqs={stalker:60,runner:90,crawler:50,mimic:120,screamer:200,shadow:40,brute:35,miasma:70,wraith:55,fungal:45,eyeball:150,leech:80,juggernaut:30,specter:65,hive:110,absorber:85,devourer:30};const f=freqs[type]||70;playTone(f,'sawtooth',.3,.25);playNoise(.2,.15,f*.5);},
  bossRoar(){for(let i=0;i<6;i++)playTone(40-i*3,'sawtooth',.5,.8,0,i*.1);playNoise(.8,.6,20);},
  doorLocked(){playTone(180,'square',.1,.4);playTone(140,'square',.15,.4,0,.08);},
  mapPiece(){playTone(550,'sine',.15,.4);playTone(730,'sine',.15,.4,0,.1);playTone(880,'sine',.2,.5,0,.2);},
  step(){if(Math.random()<.5)playNoise(.04,.06,300);},
  ambient(){playTone(40+Math.random()*20,'sine',.8,.03,Math.random()*50-25);},
  creatureAlert(){playTone(280,'square',.08,.3);playTone(220,'square',.08,.3,0,.06);},
  win(){for(let i=0;i<10;i++)playTone(220+i*88,'sine',.3,.4,0,i*.15);},
  abilityPickup(){for(let i=0;i<6;i++)playTone(260+i*120,'sine',.2,.45,0,i*.07);},
  abilityUse(){playTone(300,'square',.1,.5);playTone(500,'sine',.2,.4,0,.05);playNoise(.1,.3,500);},
  direction(){playTone(660,'sine',.08,.3);playTone(880,'sine',.08,.3,0,.1);},
  creatureReveal(){playTone(120,'sawtooth',.4,.3);playNoise(.3,.2,80);}
};
setInterval(()=>{if(gameRunning&&settings.sound&&Math.random()<.15)SND.ambient();},2000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser=null,currentUserData=null,authMode='login';
let gameRunning=false,animFrame=null,game=null,lastTime=0,saveTimer=0;
let sessionDeaths=0; // deaths in current session (max 3)
const MAX_DEATHS=3;
const keys={};
let mouseX=0,mouseY=0,mouseAngle=0;
const custom={skin:'#c8a882',shirt:'#8e1a0e',hair:'#2c1810'};
const joy={active:false,startX:0,startY:0,dx:0,dy:0,touchId:-1};
const JR=48;
let lastStepTime=0;
let bossWarningShown=new Set();
let isMobile=false;
let creatureRevealTimer=0;
const CREATURE_REVEAL_INTERVAL=30000,CREATURE_REVEAL_DURATION=1500;
let creatureRevealActive=false,creatureRevealTimeout=null;
let directionTimer=0;
const DIRECTION_INTERVAL=30000,DIRECTION_DURATION=3500;
let directionVisible=false,directionHideTimeout=null;

function detectMobile(){isMobile='ontouchstart'in window||navigator.maxTouchPoints>0;}
detectMobile();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3-DEATH WIPE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDeathPips(){
  for(let i=0;i<3;i++){
    const pip=document.getElementById('dp'+i);if(!pip)continue;
    if(i<sessionDeaths){
      pip.className='death-pip used'+(i===MAX_DEATHS-1&&sessionDeaths>=MAX_DEATHS?' last':'');
    }else{pip.className='death-pip';}
  }
}

function updateLobbyDeaths(){
  const el=document.getElementById('lobbyDeathCount');
  if(!el)return;
  const remaining=MAX_DEATHS-sessionDeaths;
  let pips='';
  for(let i=0;i<MAX_DEATHS;i++)pips+=(i<remaining)?'‚óè':'‚óã';
  el.textContent=pips;
  el.style.color=remaining===1?'#e74c3c':remaining===2?'#f39c12':'#c0392b';
}

async function triggerFinalWipe(){
  gameRunning=false;cancelAnimationFrame(animFrame);
  SND.finalDeath();
  // Wipe progress in DB
  if(currentUser){
    await DB.wipeProgress(currentUser);
    if(currentUserData){currentUserData.game_state=null;currentUserData.death_count=0;}
  }
  game=null;sessionDeaths=0;

  // Show wipe screen
  const wipeEl=document.getElementById('achievementWipe');
  wipeEl.style.display='flex';
  const fillEl=document.getElementById('awProgressFill');
  const timerEl=document.getElementById('awTimer');
  setTimeout(()=>{
    wipeEl.classList.add('show');
    fillEl.style.width='100%';
  },100);

  let countdown=4;
  timerEl.textContent='Returning in '+countdown+'s...';
  const iv=setInterval(()=>{
    countdown--;timerEl.textContent='Returning in '+countdown+'s...';
    if(countdown<=0){
      clearInterval(iv);
      wipeEl.classList.remove('show');
      setTimeout(()=>{
        wipeEl.style.display='none';
        wipeEl.style.animation='';
        updateLobbyDeaths();
        toLobby();
      },800);
    }
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPECIAL ABILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SPECIAL_ABILITIES=[
  {name:'SHADOW STEP',icon:'üë£',desc:'Invisible for 3s. Creatures lose you.',key:'Q',color:'#5d6d7e',cd:18000,activate(g){g.invisible=true;showNotif('üë£ SHADOW STEP','3s invisibility','#5d6d7e');SND.abilityUse();spawnParticles(g,g.px,g.py,'#5d6d7e',14);setTimeout(()=>{if(game)game.invisible=false;},3000);}},
  {name:'BERSERKER RUSH',icon:'‚ö°',desc:'3√ó speed, 2√ó fire rate for 4s.',key:'Q',color:'#e74c3c',cd:22000,activate(g){g.berserker=4000;showNotif('‚ö° BERSERKER RUSH','Speed & fire!','#e74c3c');SND.abilityUse();spawnParticles(g,g.px,g.py,'#e74c3c',18);}},
  {name:'IRON SHIELD',icon:'üõ°',desc:'No damage for 4s.',key:'Q',color:'#2980b9',cd:25000,activate(g){g.shielded=4000;showNotif('üõ° IRON SHIELD','Invincible 4s!','#2980b9');SND.abilityUse();spawnParticles(g,g.px,g.py,'#2980b9',14);}},
  {name:'NOVA BURST',icon:'üí•',desc:'Stuns all nearby creatures.',key:'Q',color:'#f39c12',cd:20000,activate(g){showNotif('üí• NOVA BURST','Stun all nearby!','#f39c12');SND.abilityUse();spawnParticles(g,g.px,g.py,'#f39c12',30);g.creatures.forEach(cr=>{if(!cr.dead&&Math.hypot(cr.x-g.px,cr.y-g.py)<200){cr.stunTimer=3500;cr.hp-=40;if(cr.hp<=0)cr.dead=true;}});}},
  {name:'HEAL SURGE',icon:'üíâ',desc:'Restore 50 HP instantly.',key:'Q',color:'#27ae60',cd:30000,activate(g){g.hp=Math.min(g.maxHp,g.hp+50);showNotif('üíâ HEAL SURGE','+50 HP!','#27ae60');SND.abilityUse();spawnParticles(g,g.px,g.py,'#27ae60',12);}},
  {name:'PHANTOM EYE',icon:'üëÅ',desc:'Reveals all creatures on radar for 8s.',key:'Q',color:'#9b59b6',cd:28000,activate(g){g.phantomEye=8000;showNotif('üëÅ PHANTOM EYE','All revealed!','#9b59b6');SND.abilityUse();spawnParticles(g,g.px,g.py,'#9b59b6',16);}},
  {name:'TIME WARP',icon:'‚è±',desc:'Slows all creatures to 10% for 5s.',key:'Q',color:'#00bcd4',cd:32000,activate(g){g.timeWarp=5000;showNotif('‚è± TIME WARP','Enemies slowed!','#00bcd4');SND.abilityUse();spawnParticles(g,g.px,g.py,'#00bcd4',18);}},
  {name:'DEATH MARK',icon:'‚ò†',desc:'Double weapon damage for 6s.',key:'Q',color:'#c0392b',cd:24000,activate(g){g.deathMark=6000;showNotif('‚ò† DEATH MARK','2√ó damage!','#c0392b');SND.abilityUse();spawnParticles(g,g.px,g.py,'#c0392b',20);}},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const bar=document.getElementById('loadBar'),txt=document.getElementById('loadText');
  const msgs=['LOADING WORLD...','SPAWNING HORRORS...','SEALING THE ROOMS...','CALIBRATING DARKNESS...','READY.'];
  let p=0;
  const iv=setInterval(()=>{p+=Math.random()*6+2;if(p>100)p=100;bar.style.width=p+'%';txt.textContent=msgs[Math.min(4,Math.floor(p/25))];if(p>=100){clearInterval(iv);setTimeout(()=>showScreen('authScreen'),500);}},40);
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREENS & AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){
  document.querySelectorAll('#screens>div').forEach(d=>d.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='customScreen')initCustomScreen();
  const inGame=(id==='gameScreen');
  document.getElementById('joystickZone').style.display=inGame&&isMobile?'block':'none';
  document.getElementById('actionZone').style.display=inGame&&isMobile?'block':'none';
  if(id==='lobbyScreen')updateLobbyDeaths();
}
function switchTab(mode){
  authMode=mode;
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&mode==='login')||(i===1&&mode==='register')));
  document.getElementById('authMsg').textContent='';
  document.getElementById('authId').value='';document.getElementById('authPass').value='';
  document.getElementById('authSubmitBtn').textContent=mode==='login'?'ENTER':'REGISTER';
}
async function handleAuth(){
  const id=document.getElementById('authId').value.trim(),pw=document.getElementById('authPass').value;
  const msg=document.getElementById('authMsg');msg.className='auth-msg';msg.textContent='...';
  if(!id||!pw){msg.textContent='FILL ALL FIELDS.';return;}
  try{
    if(authMode==='register'){
      const ex=await DB.getUser(id);if(ex){msg.textContent='ID ALREADY TAKEN.';return;}
      currentUserData=await DB.createUser(id,pw);currentUser=id;
      msg.className='auth-msg auth-ok';msg.textContent='REGISTERED. ENTERING...';
      sessionDeaths=0;setTimeout(toLobby,800);
    }else{
      const u=await DB.getUser(id);if(!u||u.password!==pw){msg.textContent='INVALID CREDENTIALS.';return;}
      currentUser=id;currentUserData=u;
      sessionDeaths=Math.min(u.death_count||0,MAX_DEATHS-1);
      msg.className='auth-msg auth-ok';msg.textContent='AUTHENTICATED...';setTimeout(toLobby,600);
    }
  }catch(e){msg.textContent='ERROR: '+e.message;}
}
function toLobby(){
  document.getElementById('lobbyUser').textContent=currentUser;
  if(currentUserData?.customization)Object.assign(custom,currentUserData.customization);
  updateLobbyDeaths();
  showScreen('lobbyScreen');
}
function logout(){
  currentUser=null;currentUserData=null;sessionDeaths=0;
  document.getElementById('authId').value='';document.getElementById('authPass').value='';
  authMode='login';
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  document.getElementById('authSubmitBtn').textContent='ENTER';
  showScreen('authScreen');
}
function toggleSetting(k){settings[k]=!settings[k];const bId='toggle'+k[0].toUpperCase()+k.slice(1);const b=document.getElementById(bId);if(b)b.className='toggle-btn '+(settings[k]?'on':'off');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOMIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const skinTones=['#f5cba7','#c8a882','#a0785a','#7d5442','#4a2f20','#2c1810'];
const shirtCols=['#8e1a0e','#1a2e8e','#1a8e3a','#8e7a1a','#4a1a8e','#555','#111'];
const hairCols=['#2c1810','#5a3a1a','#c8a832','#e8e8e8','#e03030','#000'];
function initCustomScreen(){renderSwatches('skinColors',skinTones,'skin');renderSwatches('shirtColors',shirtCols,'shirt');renderSwatches('hairColors',hairCols,'hair');drawPreview();}
function renderSwatches(cid,cols,prop){const c=document.getElementById(cid);c.innerHTML='';cols.forEach(col=>{const s=document.createElement('div');s.className='color-swatch'+(custom[prop]===col?' selected':'');s.style.background=col;s.onclick=()=>{custom[prop]=col;initCustomScreen();};c.appendChild(s);});}
function drawPreview(){const cv=document.getElementById('customPreview'),cx=cv.getContext('2d');cx.clearRect(0,0,80,80);drawPlayerAvatar(cx,40,42,custom.skin,custom.shirt,custom.hair);}
async function saveCustom(){await DB.saveCustom(currentUser,{...custom});if(currentUserData)currentUserData.customization={...custom};showScreen('lobbyScreen');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS + INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');
const radarCv=document.getElementById('radarCanvas'),radarCtx=radarCv.getContext('2d');
const mapCv=document.getElementById('mapPiecesCanvas'),mapCtx=mapCv.getContext('2d');
let darkCanvas=document.createElement('canvas'),darkCtx=darkCanvas.getContext('2d');

function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;resizeMpCanvas();}
window.addEventListener('resize',resize);resize();

window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();keys[k]=true;keys[e.key]=true;
  if(!gameRunning)return;
  if(e.key==='1'){setWeapon(0);e.preventDefault();}else if(e.key==='2'){setWeapon(1);e.preventDefault();}else if(e.key==='3'){setWeapon(2);e.preventDefault();}else if(e.key==='4'){setWeapon(3);e.preventDefault();}else if(e.key==='5'){setWeapon(4);e.preventDefault();}
  else if(k==='e'){switchWeapon(1);e.preventDefault();}else if(k==='f'){switchWeapon(-1);e.preventDefault();}
  else if(e.key==='Tab'){e.preventDefault();switchWeapon(1);}
  else if(k==='q'&&!e.ctrlKey&&!e.metaKey){useAbility();e.preventDefault();}
  else if(e.key===' '){e.preventDefault();shoot();}
  else if(k==='r'){reload();e.preventDefault();}
  else if(k==='m'){toggleMapPanel();e.preventDefault();}
  else if(e.key==='Escape'){pauseGame();}
});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;keys[e.key]=false;});

canvas.addEventListener('mousemove',e=>{if(!game||!gameRunning)return;mouseX=e.clientX;mouseY=e.clientY;mouseAngle=Math.atan2(e.clientY-canvas.height/2,e.clientX-canvas.width/2);game.angle=mouseAngle;});
canvas.addEventListener('mousedown',e=>{if(!gameRunning)return;if(e.button===0)shoot();if(e.button===2){useAbility();e.preventDefault();}});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

const jBase=document.getElementById('joystickBase'),jKnob=document.getElementById('joystickKnob'),jZone=document.getElementById('joystickZone');
function joyStart(e){e.preventDefault();const t=e.changedTouches[0];const r=jBase.getBoundingClientRect();joy.active=true;joy.touchId=t.identifier;joy.startX=r.left+r.width/2;joy.startY=r.top+r.height/2;joyMove(e);}
function joyMove(e){e.preventDefault();if(!joy.active)return;let t=null;for(let i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===joy.touchId){t=e.changedTouches[i];break;}}if(!t)return;let dx=t.clientX-joy.startX,dy=t.clientY-joy.startY;const dist=Math.min(Math.hypot(dx,dy),JR);const ang=Math.atan2(dy,dx);joy.dx=Math.cos(ang)*dist/JR;joy.dy=Math.sin(ang)*dist/JR;jKnob.style.left=(50+joy.dx*46)+'%';jKnob.style.top=(50+joy.dy*46)+'%';if(game&&(Math.abs(joy.dx)>.12||Math.abs(joy.dy)>.12)){mouseAngle=Math.atan2(joy.dy,joy.dx);game.angle=mouseAngle;}}
function joyEnd(){joy.active=false;joy.dx=0;joy.dy=0;jKnob.style.left='50%';jKnob.style.top='50%';}
jZone.addEventListener('touchstart',joyStart,{passive:false});jZone.addEventListener('touchmove',joyMove,{passive:false});jZone.addEventListener('touchend',joyEnd,{passive:false});jZone.addEventListener('touchcancel',joyEnd,{passive:false});

let aimTouchId=-1;
const aZone=document.getElementById('actionZone');
aZone.addEventListener('touchstart',e=>{for(let t of e.changedTouches){const el=document.elementFromPoint(t.clientX,t.clientY);if(el&&['fireBtn','reloadBtn','weaponPrevBtn','weaponNextBtn','abilityBtn','abilityBtnIcon','abilityBtnLabel'].includes(el.id))continue;aimTouchId=t.identifier;}},{passive:true});
aZone.addEventListener('touchmove',e=>{for(let t of e.changedTouches){if(t.identifier===aimTouchId&&game){mouseAngle=Math.atan2(t.clientY-canvas.height/2,t.clientX-canvas.width/2);game.angle=mouseAngle;}}},{passive:true});
document.getElementById('fireBtn').addEventListener('touchstart',e=>{e.preventDefault();shoot();},{passive:false});
document.getElementById('reloadBtn').addEventListener('touchstart',e=>{e.preventDefault();reload();},{passive:false});
document.getElementById('weaponPrevBtn').addEventListener('touchstart',e=>{e.preventDefault();switchWeapon(-1);},{passive:false});
document.getElementById('weaponNextBtn').addEventListener('touchstart',e=>{e.preventDefault();switchWeapon(1);},{passive:false});
document.getElementById('abilityBtn').addEventListener('touchstart',e=>{e.preventDefault();useAbility();},{passive:false});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TILE=32,CHUNK_SIZE=16,CHUNK_PX=TILE*CHUNK_SIZE;
const chunkCache={};
function seededRng(seed){let s=seed|0;return()=>{s=(s*1664525+1013904223)&0xffffffff;return(s>>>0)/4294967295;};}
function getChunk(cx,cy){
  const k=cx+','+cy;
  if(!chunkCache[k]){
    const rng=seededRng(cx*100003+cy*100019+777);const tiles=[];
    for(let ty=0;ty<CHUNK_SIZE;ty++){tiles[ty]=[];for(let tx=0;tx<CHUNK_SIZE;tx++){let t=0;const rv=rng();if(rv<0.11)t=1;else if(rv<0.17)t=2;else if(rv<0.21)t=3;else if(rv<0.24)t=4;if(cx===0&&cy===0&&tx<4&&ty<4)t=0;tiles[ty][tx]=t;}}
    chunkCache[k]={tiles};
  }
  return chunkCache[k];
}
function isSolid(x,y){const cx=Math.floor(x/CHUNK_PX),cy=Math.floor(y/CHUNK_PX);const tx=Math.max(0,Math.min(CHUNK_SIZE-1,Math.floor((x-cx*CHUNK_PX)/TILE)));const ty=Math.max(0,Math.min(CHUNK_SIZE-1,Math.floor((y-cy*CHUNK_PX)/TILE)));const ch=chunkCache[cx+','+cy];if(!ch)return false;const t=ch.tiles[ty][tx];return t===1||t===2||t===3;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KEY_DATA=[{name:'IRON KEY',color:'#aaaaaa',icon:'üóù'},{name:'BRASS KEY',color:'#c8a832',icon:'üîë'},{name:'SILVER KEY',color:'#c0c8d0',icon:'üîë'},{name:'GATE SEAL',color:'#27ae60',icon:'üîì'}];
const CLUE_TEXTS=['"The gate requires all four keys hidden in this forsaken land."','"Follow the glowing symbols ‚Äî they mark where the keys rest."','"Creatures guard the keys. Avoid them, or they will never stop."','"The door was locked from the inside. Who locked it?"'];
const MAP_PIECE_MSGS=["Fragment 1: A crude path leads NORTH then EAST from spawn.","Fragment 2: BOSS ROOMS are marked with red torches at corners.","Fragment 3: Hidden passage behind the EAST wall in sector 4.","Fragment 4: The gate lies FAR NORTH-EAST. Keys in guarded chambers."];
const ABILITY_PICKUP_POSITIONS=[[450,250],[620,-380],[350,680],[-500,320],[-280,-620],[750,450],[-650,180],[200,-500]];

const ALL_CREATURE_DEFS=[
  {type:'stalker',speed:1.1,chaseSpeed:2.2,hp:120,size:13,ability:'phantom',boss:false,color:{body:'#4a0066',dark:'#2d003d',glow:'#9b59b6',eye:'#d35400'}},
  {type:'runner',speed:1.8,chaseSpeed:4.5,hp:60,size:10,ability:'charge',boss:false,color:{body:'#992200',dark:'#6b0000',glow:'#e74c3c',eye:'#ffff00'}},
  {type:'crawler',speed:0.7,chaseSpeed:2.0,hp:80,size:8,ability:'camouflage',boss:false,color:{body:'#003322',dark:'#001a11',glow:'#27ae60',eye:'#00ff88'}},
  {type:'mimic',speed:0.9,chaseSpeed:2.6,hp:90,size:12,ability:'mimic',boss:false,color:{body:'#4a3a00',dark:'#2d2300',glow:'#f39c12',eye:'#ffff00'}},
  {type:'screamer',speed:1.2,chaseSpeed:2.3,hp:70,size:14,ability:'slow',boss:false,color:{body:'#660066',dark:'#3d003d',glow:'#dd55dd',eye:'#ffffff'}},
  {type:'shadow',speed:1.4,chaseSpeed:3.0,hp:50,size:11,ability:'phase',boss:false,color:{body:'#111111',dark:'#000000',glow:'#3498db',eye:'#5dade2'}},
  {type:'brute',speed:0.6,chaseSpeed:1.8,hp:250,size:20,ability:'knockback',boss:false,color:{body:'#5c0000',dark:'#3d0000',glow:'#c0392b',eye:'#ffff00'}},
  {type:'miasma',speed:1.0,chaseSpeed:2.1,hp:80,size:12,ability:'poison',boss:false,color:{body:'#1a3300',dark:'#0d1a00',glow:'#2ecc71',eye:'#a8e063'}},
  {type:'wraith',speed:1.6,chaseSpeed:3.5,hp:45,size:14,ability:'teleport',boss:false,color:{body:'#000033',dark:'#000011',glow:'#00aaff',eye:'#00ffff'}},
  {type:'juggernaut',speed:0.4,chaseSpeed:1.2,hp:400,size:28,ability:'stomp',boss:false,color:{body:'#2a0000',dark:'#1a0000',glow:'#ff2200',eye:'#ff8800'}},
  {type:'specter',speed:1.9,chaseSpeed:4.0,hp:40,size:12,ability:'blink',boss:false,color:{body:'#001a1a',dark:'#000d0d',glow:'#00ffcc',eye:'#00ffaa'}},
  {type:'hive',speed:0.8,chaseSpeed:2.0,hp:90,size:15,ability:'spawn',boss:false,color:{body:'#220a00',dark:'#110500',glow:'#ff6600',eye:'#ffaa00'}},
  {type:'devourer',speed:0.5,chaseSpeed:2.0,hp:800,size:40,ability:'boss',boss:true,color:{body:'#1a0000',dark:'#000000',glow:'#ff0000',eye:'#ff0000'},name:'THE DEVOURER'},
];

const BOSS_ROOMS=[
  {x:800,y:0,radius:200,bossType:'devourer',keyIdx:0,unlocked:false,mapPiecesNeeded:1,entered:false},
  {x:-800,y:0,radius:200,bossType:'devourer',keyIdx:1,unlocked:false,mapPiecesNeeded:2,entered:false},
  {x:0,y:800,radius:200,bossType:'devourer',keyIdx:2,unlocked:false,mapPiecesNeeded:3,entered:false},
  {x:0,y:-800,radius:200,bossType:'devourer',keyIdx:3,unlocked:false,mapPiecesNeeded:4,entered:false},
];
const LOCKED_ROOMS=[
  {x:300,y:200,radius:120,mapPieceIdx:0,collected:false,opened:false},
  {x:-300,y:400,radius:120,mapPieceIdx:1,collected:false,opened:false},
  {x:500,y:-300,radius:120,mapPieceIdx:2,collected:false,opened:false},
  {x:-500,y:-200,radius:120,mapPieceIdx:3,collected:false,opened:false},
];

function newGameState(worldSeed){
  return{px:MP_SPAWN.x,py:MP_SPAWN.y,hp:100,maxHp:100,stamina:100,angle:0,speed:2.4,worldSeed:worldSeed||777,activeWeapon:0,
    weapons:[
      {name:'PISTOL',ammo:12,maxAmmo:12,reserve:72,dmg:22,spread:.05,bullets:1,fireRate:380,reloadTime:1100,lastFire:0,color:'#ccc',icon:'üî´'},
      {name:'SHOTGUN',ammo:6,maxAmmo:6,reserve:36,dmg:14,spread:.28,bullets:8,fireRate:880,reloadTime:1800,lastFire:0,color:'#c8a832',icon:'üí•'},
      {name:'SNIPER',ammo:5,maxAmmo:5,reserve:25,dmg:78,spread:.01,bullets:1,fireRate:1400,reloadTime:2200,lastFire:0,color:'#5dade2',icon:'üéØ'},
    ],
    inventory:[{type:'pistol',label:'PISTOL',icon:'üî´'},{type:'shotgun',label:'SHOTGN',icon:'üí•'},{type:'sniper',label:'SNIPER',icon:'üéØ'},null,null],
    creatures:[],bullets:[],particles:[],pickups:[],clues:[],keys:[],
    gatePos:{x:1200,y:-1200},keysFound:0,totalKeys:4,cluesFound:0,
    storyProgress:0,caughtTimes:0,time:0,reloading:false,reloadStart:0,
    dangerLevel:0,slowed:0,poisoned:0,knockbackVx:0,knockbackVy:0,
    lastGuide:0,guideQueue:[],
    mapPiecesFound:0,totalMapPieces:4,
    bossRooms:JSON.parse(JSON.stringify(BOSS_ROOMS)),
    lockedRooms:JSON.parse(JSON.stringify(LOCKED_ROOMS)),
    mapFragments:[false,false,false,false],
    ambientTimer:0,
    specialAbility:null,specialAbilityCd:0,
    invisible:false,berserker:0,shielded:0,phantomEye:0,timeWarp:0,deathMark:0,
    abilityPickups:[],
  };
}

function spawnWorld(g){
  const SPREAD=[[380,0],[720,300],[300,720],[1000,400],[400,1000],[-380,0],[-720,300],[-300,720],[-1000,400],[-400,1000],[600,-500],[800,-200],[-600,-500],[-800,-200],[200,-700],[-200,-700],[1500,500],[500,1500],[-1500,500],[-500,1500],[1200,1200],[-1200,1200],[1200,-1200],[-1200,-1200]];
  const normalTypes=ALL_CREATURE_DEFS.filter(d=>!d.boss);
  for(let i=0;i<Math.min(SPREAD.length,normalTypes.length*2);i++){const def=normalTypes[i%normalTypes.length];const pos=SPREAD[i];g.creatures.push(makeCreature(def,pos[0],pos[1],i));}
  g.bossRooms.forEach((room,ri)=>{const def=ALL_CREATURE_DEFS.find(d=>d.type==='devourer');const boss=makeCreature(def,room.x,room.y,100+ri);boss.isBoss=true;boss.bossRoomIdx=ri;boss.name=def.name||'THE DEVOURER';g.creatures.push(boss);});
  g.bossRooms.forEach((room,i)=>{g.keys.push({id:i,found:false,x:room.x,y:room.y+30,...KEY_DATA[i],pulseT:Math.random()*Math.PI*2,bossRoomIdx:i});});
  for(let i=0;i<4;i++){const a=Math.random()*Math.PI*2,d=200+Math.random()*500;g.clues.push({x:Math.cos(a)*d,y:Math.sin(a)*d,found:false,text:CLUE_TEXTS[i%CLUE_TEXTS.length],id:i});}
  for(let i=0;i<18;i++){const a=Math.random()*Math.PI*2,d=150+Math.random()*900;const type=Math.random()<.5?'ammo':'health';g.pickups.push({x:Math.cos(a)*d,y:Math.sin(a)*d,type,found:false,value:type==='health'?25:Math.floor(Math.random()*3+1)});}
  g.lockedRooms.forEach(()=>{});// map pieces handled separately via lockedRooms
  ABILITY_PICKUP_POSITIONS.forEach((pos,i)=>{g.abilityPickups.push({x:pos[0],y:pos[1],abilityIdx:i%SPECIAL_ABILITIES.length,found:false,pulseT:Math.random()*Math.PI*2});});
  g.guideQueue=[
    {title:'WELCOME',msg:'Find üó∫ MAP FRAGMENTS (blue on radar) ‚Üí Boss Rooms ‚Üí 4 Keys ‚Üí EXIT GATE. You have 3 lives ‚Äî use them wisely!'},
    {title:'STEP 1 ‚Äî MAP FRAGMENTS',msg:'Walk into the blue glowing circles. Collect all 4 to unlock boss rooms.'},
    {title:'STEP 2 ‚Äî BOSS ROOMS',msg:'Red on radar. Defeat THE DEVOURER for each key. Need 4 keys total!'},
    {title:'STEP 3 ‚Äî EXIT GATE',msg:'Far north-east (green on radar). All 4 keys ‚Üí escape!'},
    {title:'‚ö† 3-DEATH WARNING',msg:'You only get 3 lives. After 3 deaths ALL progress is wiped and you return to main menu!'},
  ];
}

function makeCreature(def,x,y,id){
  return{...def,x,y,maxHp:def.hp,hp:def.hp,vx:0,vy:0,facing:Math.random()*Math.PI*2,state:'patrol',alertLevel:0,lastSeen:0,patrolAngle:Math.random()*Math.PI*2,wanderTimer:0,id,dead:false,abilityTimer:2000+Math.random()*3000,stunTimer:0,chargeAngle:0,charging:false,chargeTimer:0,mimicRevealed:false,spawnGlowTimer:1500,spawnGlowing:true,glowPhase:Math.random()*Math.PI*2,revealGlow:0};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREATURE REVEAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCreatureReveal(dt){
  if(!settings.creatureReveal)return;
  creatureRevealTimer+=dt;
  if(creatureRevealTimer>=CREATURE_REVEAL_INTERVAL&&!creatureRevealActive){creatureRevealTimer=0;triggerCreatureReveal();}
  if(creatureRevealActive&&game)game.creatures.forEach(cr=>{if(!cr.dead)cr.revealGlow=Math.max(0,(cr.revealGlow||0)-dt*0.8/CREATURE_REVEAL_DURATION);});
}
function triggerCreatureReveal(){
  if(!game)return;creatureRevealActive=true;SND.creatureReveal();
  game.creatures.forEach(cr=>{if(!cr.dead)cr.revealGlow=1;});
  const flashEl=document.getElementById('creatureFlash');flashEl.classList.add('active');
  clearTimeout(creatureRevealTimeout);
  creatureRevealTimeout=setTimeout(()=>{creatureRevealActive=false;flashEl.classList.remove('active');},CREATURE_REVEAL_DURATION);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FLOOR_PAL=['#0e0e0e','#111','#0d0d0d','#131313','#0f0f0f'];
const WALL_PAL=['#222','#1e1e1e','#252525','#1c1c1c'];

function renderWorld(g){
  if(!g||!g.creatures)return;
  const W=canvas.width,H=canvas.height,camX=g.px-W/2,camY=g.py-H/2;
  ctx.fillStyle='#080808';ctx.fillRect(0,0,W,H);
  const s0x=Math.floor(camX/CHUNK_PX)-1,e0x=Math.ceil((camX+W)/CHUNK_PX)+1;
  const s0y=Math.floor(camY/CHUNK_PX)-1,e0y=Math.ceil((camY+H)/CHUNK_PX)+1;
  for(let ccx=s0x;ccx<=e0x;ccx++)for(let ccy=s0y;ccy<=e0y;ccy++){
    const ch=getChunk(ccx,ccy);const chWx=ccx*CHUNK_PX,chWy=ccy*CHUNK_PX;
    for(let ty=0;ty<CHUNK_SIZE;ty++)for(let tx=0;tx<CHUNK_SIZE;tx++){
      const wx=chWx+tx*TILE,wy=chWy+ty*TILE,sx=wx-camX,sy=wy-camY;
      if(sx>W+TILE||sx<-TILE||sy>H+TILE||sy<-TILE)continue;
      drawTile(ctx,ch.tiles[ty][tx],sx,sy,seededRng(ccx*9999+ccy*1111+tx*37+ty*13),g.time);
    }
  }
  // Boss rooms
  g.bossRooms.forEach((room,ri)=>{
    const sx=room.x-camX,sy=room.y-camY;
    if(Math.abs(sx)>W+300||Math.abs(sy)>H+300)return;
    const rg=ctx.createRadialGradient(sx,sy,0,sx,sy,room.radius);rg.addColorStop(0,'rgba(180,0,0,0.12)');rg.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=rg;ctx.beginPath();ctx.arc(sx,sy,room.radius,0,Math.PI*2);ctx.fill();
    for(let ci=0;ci<4;ci++){const ca=ci/4*Math.PI*2;const tx2=sx+Math.cos(ca)*room.radius*.85,ty2=sy+Math.sin(ca)*room.radius*.85;const tg=ctx.createRadialGradient(tx2,ty2,0,tx2,ty2,18);tg.addColorStop(0,'rgba(255,80,0,0.7)');tg.addColorStop(1,'rgba(255,0,0,0)');ctx.fillStyle=tg;ctx.beginPath();ctx.arc(tx2,ty2,18,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff4400';ctx.shadowBlur=12;ctx.shadowColor='#ff2200';ctx.beginPath();ctx.arc(tx2,ty2,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
    const keyFound=g.keys[ri]&&g.keys[ri].found;
    if(!keyFound){ctx.strokeStyle=g.mapPiecesFound>=room.mapPiecesNeeded?'rgba(255,80,0,0.3)':'rgba(255,0,0,0.55)';ctx.lineWidth=2;ctx.setLineDash([6,6]);ctx.beginPath();ctx.arc(sx,sy,room.radius,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.font='9px Share Tech Mono';ctx.fillStyle='rgba(255,60,60,0.7)';ctx.textAlign='center';ctx.fillText(g.mapPiecesFound>=room.mapPiecesNeeded?'BOSS ROOM':'üîí '+(room.mapPiecesNeeded-g.mapPiecesFound)+' FRAGS',sx,sy-room.radius-8);}
  });
  // Locked rooms (map fragments)
  g.lockedRooms.forEach(room=>{
    if(room.collected)return;const sx=room.x-camX,sy=room.y-camY;if(Math.abs(sx)>W+200||Math.abs(sy)>H+200)return;
    const pulse=Math.sin(g.time*.003)*.3+.7;const lg=ctx.createRadialGradient(sx,sy,0,sx,sy,room.radius);lg.addColorStop(0,'rgba(80,120,255,0.1)');lg.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=lg;ctx.beginPath();ctx.arc(sx,sy,room.radius,0,Math.PI*2);ctx.fill();ctx.strokeStyle=`rgba(100,150,255,${pulse*.5})`;ctx.lineWidth=1.5;ctx.setLineDash([4,8]);ctx.beginPath();ctx.arc(sx,sy,room.radius,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.font='13px serif';ctx.textAlign='center';ctx.fillStyle=`rgba(100,150,255,${pulse})`;ctx.shadowBlur=14;ctx.shadowColor='#6699ff';ctx.fillText('üó∫',sx,sy+6);ctx.shadowBlur=0;ctx.font='8px Share Tech Mono';ctx.fillStyle='rgba(100,150,255,0.6)';ctx.fillText('MAP FRAGMENT',sx,sy+22);
  });
  // Gate
  const gsx=g.gatePos.x-camX,gsy=g.gatePos.y-camY;
  if(Math.abs(gsx)<W+100&&Math.abs(gsy)<H+100){
    const gc=g.keysFound>=g.totalKeys?'#27ae60':'#222';ctx.save();ctx.shadowBlur=g.keysFound>=g.totalKeys?35:4;ctx.shadowColor=gc;ctx.strokeStyle=gc;ctx.lineWidth=3;ctx.strokeRect(gsx-24,gsy-40,48,64);ctx.lineWidth=1.5;for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(gsx-18+i*12,gsy-40);ctx.lineTo(gsx-18+i*12,gsy+24);ctx.stroke();}ctx.beginPath();ctx.arc(gsx,gsy-40,24,Math.PI,0);ctx.stroke();ctx.font='7px Share Tech Mono';ctx.fillStyle=gc;ctx.textAlign='center';ctx.shadowBlur=0;ctx.fillText(g.keysFound+'/'+g.totalKeys+' KEYS',gsx,gsy+37);ctx.fillText('EXIT GATE',gsx,gsy-52);ctx.restore();
  }
  // Ability pickups
  g.abilityPickups.forEach(ap=>{
    if(ap.found)return;const sx=ap.x-camX,sy=ap.y-camY;if(Math.abs(sx)>W+100||Math.abs(sy)>H+100)return;
    ap.pulseT+=.04;const pulse=Math.sin(ap.pulseT)*.5+.5;const ab=SPECIAL_ABILITIES[ap.abilityIdx];
    ctx.save();ctx.shadowBlur=20+pulse*18;ctx.shadowColor=ab.color;ctx.fillStyle=ab.color;ctx.globalAlpha=.7+pulse*.3;ctx.beginPath();ctx.arc(sx,sy,8+pulse*3,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;ctx.font='14px serif';ctx.textAlign='center';ctx.shadowBlur=15;ctx.shadowColor=ab.color;ctx.fillText(ab.icon,sx,sy+5);ctx.shadowBlur=0;ctx.restore();
    ctx.font='7px Share Tech Mono';ctx.fillStyle=ab.color;ctx.textAlign='center';ctx.fillText(ab.name,sx,sy+22);
  });
  // Pickups
  g.pickups.forEach(pk=>{if(pk.found)return;const sx=pk.x-camX,sy=pk.y-camY;if(Math.abs(sx)>W||Math.abs(sy)>H)return;const bob=Math.sin(g.time*.002+pk.x*.01)*3;ctx.save();ctx.textAlign='center';if(pk.type==='health'){ctx.fillStyle='#e74c3c';ctx.shadowBlur=14;ctx.shadowColor='#e74c3c';ctx.font='18px serif';ctx.fillText('‚ô•',sx,sy+bob+6);}else if(pk.type!=='mappiece'){ctx.fillStyle='#f39c12';ctx.shadowBlur=10;ctx.shadowColor='#f39c12';ctx.font='14px serif';ctx.fillText('‚¨°',sx,sy+bob+5);}ctx.shadowBlur=0;ctx.restore();});
  g.clues.forEach(cl=>{if(cl.found)return;const sx=cl.x-camX,sy=cl.y-camY;if(Math.abs(sx)>W||Math.abs(sy)>H)return;const fl=Math.sin(g.time*.0025+cl.id)*.35+.65;ctx.save();ctx.globalAlpha=fl;ctx.fillStyle='#c0392b';ctx.shadowBlur=15;ctx.shadowColor='#c0392b';ctx.font='bold 11px Share Tech Mono';ctx.textAlign='center';ctx.fillText('?',sx,sy+4);ctx.shadowBlur=0;ctx.restore();});
  g.keys.forEach(k=>{if(k.found)return;const sx=k.x-camX,sy=k.y-camY;if(Math.abs(sx)>W+100||Math.abs(sy)>H+100)return;k.pulseT+=.035;const pulse=Math.sin(k.pulseT)*.4+.6;ctx.save();ctx.beginPath();ctx.arc(sx,sy,16+pulse*5,0,Math.PI*2);ctx.strokeStyle=k.color+'55';ctx.lineWidth=2;ctx.stroke();ctx.fillStyle='#0a0a0a';ctx.beginPath();ctx.arc(sx,sy,10,0,Math.PI*2);ctx.fill();ctx.fillStyle=k.color;ctx.shadowBlur=22;ctx.shadowColor=k.color;ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(k.icon,sx,sy);ctx.shadowBlur=0;ctx.textBaseline='alphabetic';ctx.restore();});
  // Particles
  g.particles.forEach(p=>{ctx.globalAlpha=Math.max(0,p.life/p.maxLife);ctx.fillStyle=p.color;ctx.fillRect(p.x-camX-p.r,p.y-camY-p.r,p.r*2,p.r*2);});ctx.globalAlpha=1;
  // Bullets
  g.bullets.forEach(b=>{const sx=b.x-camX,sy=b.y-camY;ctx.fillStyle=b.color;ctx.shadowBlur=10;ctx.shadowColor=b.color;ctx.beginPath();ctx.arc(sx,sy,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;});
  // Creatures
  g.creatures.forEach(cr=>{if(!cr.dead){if(cr.spawnGlowing)drawCreatureSpawnGlow(ctx,cr,camX,camY,g.time);else drawCreature(ctx,cr,camX,camY,g.time,g);}});
  drawPlayer(ctx,W/2,H/2,g);
  renderFlashlight(g,W/2,H/2,W,H);
  if(creatureRevealActive)renderCreatureReveal(g,camX,camY,W,H);
  renderMpPlayers(g);
}

function renderCreatureReveal(g,camX,camY,W,H){
  g.creatures.forEach(cr=>{
    if(cr.dead||cr.spawnGlowing||!cr.revealGlow||cr.revealGlow<=0)return;
    const sx=cr.x-camX,sy=cr.y-camY;
    if(sx<-120||sx>W+120||sy<-120||sy>H+120)return;
    const col=cr.color||{glow:'#ff0000'};const glow=cr.revealGlow;
    ctx.save();
    const grad=ctx.createRadialGradient(sx,sy,0,sx,sy,cr.size*4);
    grad.addColorStop(0,hexToRgba(cr.isBoss?'#ff0000':col.glow,glow*0.9));grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(sx,sy,cr.size*4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=cr.isBoss?'#ff0000':col.glow;ctx.globalAlpha=glow*0.85;ctx.shadowBlur=30*glow;ctx.shadowColor=cr.isBoss?'#ff0000':col.glow;
    ctx.beginPath();ctx.arc(sx,sy,cr.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.globalAlpha=glow;ctx.font='bold 8px Share Tech Mono';ctx.fillStyle=cr.isBoss?'#ff4444':col.glow;ctx.textAlign='center';ctx.shadowBlur=8;ctx.shadowColor=col.glow;
    ctx.fillText(cr.isBoss?(cr.name||'BOSS'):cr.type.toUpperCase(),sx,sy-cr.size-6);ctx.shadowBlur=0;ctx.restore();ctx.globalAlpha=1;
  });
}

function drawCreatureSpawnGlow(ctx,cr,camX,camY,time){
  const sx=cr.x-camX,sy=cr.y-camY,W=ctx.canvas.width,H=ctx.canvas.height;
  if(sx<-120||sx>W+120||sy<-120||sy>H+120)return;
  const progress=1-(cr.spawnGlowTimer/1500);const glowPulse=Math.sin(time*.015+cr.glowPhase)*.5+.5;const col=cr.color||{glow:'#ff0000'};
  const glowRadius=cr.size*3*(0.5+progress*1.5);const glowAlpha=(0.15+progress*0.5)*(0.7+glowPulse*.3);
  ctx.save();const glowCol=cr.isBoss?'#ff0000':col.glow;
  const grad=ctx.createRadialGradient(sx,sy,0,sx,sy,glowRadius);grad.addColorStop(0,hexToRgba(glowCol,glowAlpha));grad.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=grad;ctx.beginPath();ctx.arc(sx,sy,glowRadius,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=0.15+progress*0.4;ctx.fillStyle=glowCol;ctx.shadowBlur=25+glowPulse*20;ctx.shadowColor=glowCol;
  ctx.beginPath();ctx.arc(sx,sy,cr.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  if(progress>.7){ctx.globalAlpha=(progress-.7)/.3;ctx.font='bold 8px Share Tech Mono';ctx.fillStyle='#ff0000';ctx.textAlign='center';ctx.shadowBlur=8;ctx.shadowColor='#ff0000';ctx.fillText('‚ö†',sx,sy-cr.size-8);ctx.shadowBlur=0;}
  ctx.restore();ctx.globalAlpha=1;
}

function drawTile(ctx,t,sx,sy,rng,time){
  rng();
  if(t===0){ctx.fillStyle=FLOOR_PAL[Math.floor(rng()*5)];ctx.fillRect(sx,sy,TILE,TILE);if(rng()<.12){ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(sx+rng()*20,sy+rng()*20,TILE*.3,TILE*.3);}}
  else if(t===1){ctx.fillStyle=WALL_PAL[Math.floor(rng()*4)];ctx.fillRect(sx,sy,TILE,TILE);ctx.strokeStyle='rgba(0,0,0,.45)';ctx.lineWidth=1;ctx.strokeRect(sx+1,sy+1,TILE-2,TILE-2);}
  else if(t===2){ctx.fillStyle='#090909';ctx.fillRect(sx,sy,TILE,TILE);ctx.fillStyle='#0a1805';ctx.shadowBlur=6;ctx.shadowColor='#0a1805';ctx.beginPath();ctx.arc(sx+16,sy+16,11+rng()*3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
  else if(t===3){ctx.fillStyle='#0d0d0d';ctx.fillRect(sx,sy,TILE,TILE);ctx.fillStyle='#232323';ctx.beginPath();ctx.moveTo(sx+8,sy+4);ctx.lineTo(sx+20,sy+8);ctx.lineTo(sx+22,sy+20);ctx.lineTo(sx+10,sy+26);ctx.lineTo(sx,sy+18);ctx.closePath();ctx.fill();}
  else if(t===4){ctx.fillStyle=FLOOR_PAL[Math.floor(rng()*5)];ctx.fillRect(sx,sy,TILE,TILE);ctx.fillStyle='rgba(70,0,0,.4)';ctx.beginPath();ctx.ellipse(sx+16,sy+16,11+rng()*5,6+rng()*4,rng()*Math.PI,0,Math.PI*2);ctx.fill();}
}

function drawPlayer(ctx,px,py,g){
  if(g.shielded>0){ctx.save();ctx.strokeStyle='rgba(41,128,185,0.6)';ctx.lineWidth=3;ctx.shadowBlur=18;ctx.shadowColor='#2980b9';ctx.beginPath();ctx.arc(px,py,20,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;ctx.restore();}
  if(g.invisible){ctx.save();ctx.globalAlpha=0.25;}
  ctx.fillStyle='rgba(0,0,0,.3)';ctx.beginPath();ctx.ellipse(px,py+10,11,5,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=custom.shirt;ctx.beginPath();ctx.ellipse(px,py+3,9,7,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=custom.skin;ctx.beginPath();ctx.arc(px,py-4,9,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=custom.hair;ctx.beginPath();ctx.arc(px,py-6,8,Math.PI+.2,-.2);ctx.fill();
  const ex=Math.cos(g.angle)*7,ey=Math.sin(g.angle)*7;
  ctx.fillStyle='#fff';[1,-1].forEach(s=>{ctx.beginPath();ctx.arc(px+ex+Math.cos(g.angle+Math.PI/2)*2.5*s,py-4+ey+Math.sin(g.angle+Math.PI/2)*2.5*s,1.5,0,Math.PI*2);ctx.fill();});
  const wc=g.weapons[g.activeWeapon].color;
  ctx.strokeStyle=wc;ctx.lineWidth=2;ctx.shadowBlur=6;ctx.shadowColor=wc;
  ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(px+Math.cos(g.angle)*20,py+Math.sin(g.angle)*20);ctx.stroke();ctx.shadowBlur=0;
  if(g.invisible)ctx.restore();
  if(g.berserker>0){ctx.save();ctx.strokeStyle='rgba(231,76,60,0.7)';ctx.lineWidth=2;ctx.shadowBlur=14;ctx.shadowColor='#e74c3c';ctx.beginPath();ctx.arc(px,py,22+Math.sin(g.time*.02)*4,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;ctx.restore();}
}

function drawCreature(ctx,cr,camX,camY,time,g){
  const sx=cr.x-camX,sy=cr.y-camY;const W=ctx.canvas.width,H=ctx.canvas.height;
  if(sx<-120||sx>W+120||sy<-120||sy>H+120)return;
  const col=cr.color||{body:'#800',dark:'#500',glow:'#f00',eye:'#ff0'};
  ctx.save();
  if(cr.isBoss){drawBoss(ctx,cr,sx,sy,col,time);ctx.restore();return;}
  if(cr.type==='crawler'&&cr.state!=='chase')ctx.globalAlpha=.18;
  else if(cr.type==='stalker'&&cr.state==='patrol')ctx.globalAlpha=.45+Math.sin(time*.004)*.2;
  else if(cr.type==='shadow')ctx.globalAlpha=cr.state==='chase'?.75:.06;
  else if(cr.type==='wraith')ctx.globalAlpha=cr.state==='chase'?.85:.3+Math.sin(time*.006)*.2;
  else if(cr.type==='specter')ctx.globalAlpha=cr.state==='chase'?.8:.15+Math.sin(time*.005)*.1;
  else if(cr.type==='mimic'&&!cr.mimicRevealed){ctx.globalAlpha=1;ctx.fillStyle='#f39c12';ctx.shadowBlur=10;ctx.shadowColor='#f39c12';ctx.font='16px serif';ctx.textAlign='center';ctx.fillText('‚¨°',sx,sy+4);ctx.shadowBlur=0;ctx.restore();return;}
  const alertGlow=cr.alertLevel*40;
  if(cr.state==='chase'){ctx.shadowBlur=25+alertGlow;ctx.shadowColor=col.glow;}else{ctx.shadowBlur=8+Math.sin(time*.003+cr.id)*4;ctx.shadowColor=col.glow+'88';}
  const bob=Math.sin(time*.004+cr.id*1.1)*2;
  ctx.fillStyle=col.body;ctx.beginPath();ctx.arc(sx,sy+bob,cr.size,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=col.dark;ctx.beginPath();ctx.arc(sx,sy+bob,cr.size*.6,0,Math.PI*2);ctx.fill();
  const ex2=Math.cos(cr.facing)*cr.size*.5,ey2=Math.sin(cr.facing)*cr.size*.5;
  ctx.fillStyle=col.eye;ctx.shadowBlur=8;ctx.shadowColor=col.eye;
  [1,-1].forEach(s=>{ctx.beginPath();ctx.arc(sx+ex2+Math.cos(cr.facing+Math.PI/2)*cr.size*.25*s,sy+bob+ey2+Math.sin(cr.facing+Math.PI/2)*cr.size*.25*s,cr.size*.15,0,Math.PI*2);ctx.fill();});
  ctx.shadowBlur=0;
  if(cr.alertLevel>0&&cr.alertLevel<1){ctx.globalAlpha=1;ctx.fillStyle='#111';ctx.fillRect(sx-16,sy-cr.size-14,32,4);ctx.fillStyle=cr.alertLevel>.65?'#e74c3c':'#f39c12';ctx.fillRect(sx-16,sy-cr.size-14,32*cr.alertLevel,4);}
  if(cr.hp<cr.maxHp){ctx.globalAlpha=.8;const bw=cr.size*2.5;ctx.fillStyle='#111';ctx.fillRect(sx-bw/2,sy-cr.size-22,bw,4);ctx.fillStyle='#e74c3c';ctx.fillRect(sx-bw/2,sy-cr.size-22,bw*(cr.hp/cr.maxHp),4);ctx.globalAlpha=1;}
  ctx.restore();ctx.globalAlpha=1;
}

function drawBoss(ctx,cr,sx,sy,col,time){
  const s=cr.size;
  const ag=ctx.createRadialGradient(sx,sy,0,sx,sy,s*4);ag.addColorStop(0,'rgba(180,0,0,0.25)');ag.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=ag;ctx.beginPath();ctx.arc(sx,sy,s*4,0,Math.PI*2);ctx.fill();
  for(let i=0;i<12;i++){const a=i/12*Math.PI*2+time*.002;const len=s*1.8+Math.sin(time*.008+i)*(s*.5);ctx.strokeStyle=col.body;ctx.lineWidth=4;ctx.shadowBlur=10;ctx.shadowColor=col.glow;ctx.beginPath();ctx.moveTo(sx+Math.cos(a)*s*.5,sy+Math.sin(a)*s*.5);ctx.quadraticCurveTo(sx+Math.cos(a+.4)*len*.6,sy+Math.sin(a+.4)*len*.6,sx+Math.cos(a)*len,sy+Math.sin(a)*len);ctx.stroke();}
  ctx.fillStyle=col.body;ctx.shadowBlur=30;ctx.shadowColor=col.glow;ctx.beginPath();ctx.arc(sx,sy,s,0,Math.PI*2);ctx.fill();ctx.fillStyle=col.dark;ctx.beginPath();ctx.arc(sx,sy,s*.7,0,Math.PI*2);ctx.fill();
  for(let i=0;i<8;i++){const ea=i/8*Math.PI*2;const er=s*.55;ctx.fillStyle='#fff';ctx.shadowBlur=8;ctx.shadowColor='#ff0000';ctx.beginPath();ctx.arc(sx+Math.cos(ea)*er,sy+Math.sin(ea)*er,s*.12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff0000';ctx.beginPath();ctx.arc(sx+Math.cos(ea)*er,sy+Math.sin(ea)*er,s*.06,0,Math.PI*2);ctx.fill();}
  const bw=s*3;ctx.globalAlpha=.9;ctx.fillStyle='#1a0000';ctx.fillRect(sx-bw/2,sy-s-30,bw,10);const hpPct=cr.hp/cr.maxHp;ctx.fillStyle=hpPct>.5?'#e74c3c':hpPct>.25?'#ff7700':'#ff0000';ctx.fillRect(sx-bw/2,sy-s-30,bw*hpPct,10);ctx.strokeStyle='rgba(255,0,0,0.4)';ctx.lineWidth=1;ctx.strokeRect(sx-bw/2,sy-s-30,bw,10);ctx.globalAlpha=1;ctx.font='bold 9px Creepster,serif';ctx.fillStyle='#ff4444';ctx.textAlign='center';ctx.shadowBlur=0;ctx.fillText((cr.name||'BOSS')+'  '+Math.ceil(cr.hp)+'/'+cr.maxHp,sx,sy-s-34);
}

function renderFlashlight(g,px,py,W,H){
  if(darkCanvas.width!==W||darkCanvas.height!==H){darkCanvas.width=W;darkCanvas.height=H;}
  const r=settings.flashlightRadius,angle=g.angle,spread=Math.PI/3.2;
  darkCtx.clearRect(0,0,W,H);darkCtx.fillStyle='rgba(0,0,0,0.94)';darkCtx.fillRect(0,0,W,H);
  darkCtx.save();darkCtx.globalCompositeOperation='destination-out';
  const grad=darkCtx.createRadialGradient(px,py,0,px,py,r);grad.addColorStop(0,'rgba(0,0,0,1)');grad.addColorStop(.5,'rgba(0,0,0,.97)');grad.addColorStop(.85,'rgba(0,0,0,.55)');grad.addColorStop(1,'rgba(0,0,0,0)');darkCtx.fillStyle=grad;darkCtx.beginPath();darkCtx.moveTo(px,py);darkCtx.arc(px,py,r,angle-spread,angle+spread);darkCtx.closePath();darkCtx.fill();
  const amb=darkCtx.createRadialGradient(px,py,0,px,py,44);amb.addColorStop(0,'rgba(0,0,0,.72)');amb.addColorStop(1,'rgba(0,0,0,0)');darkCtx.fillStyle=amb;darkCtx.beginPath();darkCtx.arc(px,py,44,0,Math.PI*2);darkCtx.fill();darkCtx.restore();
  ctx.drawImage(darkCanvas,0,0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RADAR ‚Äî Teammates always shown
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRadar(g){
  if(!settings.minimap||!g)return;
  const S=90,R=43,cx=45,cy=45,sc=0.045;
  radarCtx.clearRect(0,0,S,S);radarCtx.fillStyle='rgba(0,0,0,.92)';radarCtx.beginPath();radarCtx.arc(cx,cy,R,0,Math.PI*2);radarCtx.fill();
  for(let ri2=R*.33;ri2<=R;ri2+=R*.33){radarCtx.strokeStyle='rgba(0,80,0,0.2)';radarCtx.lineWidth=.5;radarCtx.beginPath();radarCtx.arc(cx,cy,ri2,0,Math.PI*2);radarCtx.stroke();}
  radarCtx.strokeStyle='rgba(0,80,0,0.15)';radarCtx.lineWidth=.5;radarCtx.beginPath();radarCtx.moveTo(cx-R,cy);radarCtx.lineTo(cx+R,cy);radarCtx.stroke();radarCtx.beginPath();radarCtx.moveTo(cx,cy-R);radarCtx.lineTo(cx,cy+R);radarCtx.stroke();
  radarCtx.save();radarCtx.beginPath();radarCtx.arc(cx,cy,R,0,Math.PI*2);radarCtx.clip();
  // Gate
  const gdx=(g.gatePos.x-g.px)*sc,gdy=(g.gatePos.y-g.py)*sc;
  if(Math.hypot(gdx,gdy)<R){radarCtx.fillStyle=g.keysFound>=g.totalKeys?'#27ae60':'#2a2a2a';radarCtx.fillRect(cx+gdx-2,cy+gdy-2,4,4);}
  else{const ga=Math.atan2(gdy,gdx);radarCtx.fillStyle='rgba(0,200,100,0.5)';radarCtx.beginPath();radarCtx.moveTo(cx+Math.cos(ga)*(R-5),cy+Math.sin(ga)*(R-5));radarCtx.lineTo(cx+Math.cos(ga+.4)*(R-12),cy+Math.sin(ga+.4)*(R-12));radarCtx.lineTo(cx+Math.cos(ga-.4)*(R-12),cy+Math.sin(ga-.4)*(R-12));radarCtx.closePath();radarCtx.fill();}
  // Boss rooms
  g.bossRooms.forEach((room,ri)=>{const rdx=(room.x-g.px)*sc,rdy=(room.y-g.py)*sc;const rkey=g.keys[ri];if(Math.hypot(rdx,rdy)<R){radarCtx.fillStyle=rkey&&rkey.found?'#333':'#ff2200';radarCtx.beginPath();radarCtx.arc(cx+rdx,cy+rdy,4,0,Math.PI*2);radarCtx.fill();}else{const ba=Math.atan2(rdy,rdx);radarCtx.fillStyle='rgba(255,34,0,0.4)';radarCtx.beginPath();radarCtx.arc(cx+Math.cos(ba)*(R-6),cy+Math.sin(ba)*(R-6),3,0,Math.PI*2);radarCtx.fill();}});
  // Locked rooms
  g.lockedRooms.forEach(room=>{if(room.collected)return;const ldx=(room.x-g.px)*sc,ldy=(room.y-g.py)*sc;if(Math.hypot(ldx,ldy)<R){radarCtx.fillStyle='#4466ff';radarCtx.beginPath();radarCtx.arc(cx+ldx,cy+ldy,3,0,Math.PI*2);radarCtx.fill();}});
  // Keys
  g.keys.forEach(k=>{if(k.found)return;const kdx=(k.x-g.px)*sc,kdy=(k.y-g.py)*sc;if(Math.hypot(kdx,kdy)<R){radarCtx.fillStyle=k.color;radarCtx.beginPath();radarCtx.arc(cx+kdx,cy+kdy,2.5,0,Math.PI*2);radarCtx.fill();}});
  // Ability pickups
  g.abilityPickups.forEach(ap=>{if(ap.found)return;const adx=(ap.x-g.px)*sc,ady=(ap.y-g.py)*sc;if(Math.hypot(adx,ady)<R){const ab=SPECIAL_ABILITIES[ap.abilityIdx];radarCtx.fillStyle=ab.color;radarCtx.beginPath();radarCtx.arc(cx+adx,cy+ady,3,0,Math.PI*2);radarCtx.fill();}});
  // Creatures
  g.creatures.forEach(cr=>{
    if(cr.dead||Math.hypot(cr.x-g.px,cr.y-g.py)>440)return;
    const cdx=(cr.x-g.px)*sc,cdy=(cr.y-g.py)*sc;
    if(Math.hypot(cdx,cdy)<R){
      const show=g.phantomEye>0||cr.state==='chase'||cr.spawnGlowing||creatureRevealActive;
      if(!show&&Math.hypot(cr.x-g.px,cr.y-g.py)>settings.flashlightRadius*1.5)return;
      radarCtx.fillStyle=cr.isBoss?'#ff0000':cr.state==='chase'?'#e74c3c':'#5a0000';
      radarCtx.beginPath();radarCtx.arc(cx+cdx,cy+cdy,cr.isBoss?4:1.8,0,Math.PI*2);radarCtx.fill();
    }
  });
  // ‚òÖ TEAMMATES ALWAYS ON RADAR
  if(isMultiplayer&&multiRoom){
    Object.entries(multiRoom.players).forEach(([uid,p])=>{
      if(uid===currentUser)return;
      const state=mpRemoteStates[uid]||p;if(!state)return;
      if(state.ts&&Date.now()-state.ts>8000)return;
      const pdx=(state.x-g.px)*sc,pdy=(state.y-g.py)*sc;
      const col=state.color||'#3498db';
      radarCtx.save();
      if(Math.hypot(pdx,pdy)<R){
        // Pulsing dot
        radarCtx.fillStyle=col;radarCtx.shadowBlur=8;radarCtx.shadowColor=col;
        radarCtx.beginPath();radarCtx.arc(cx+pdx,cy+pdy,4,0,Math.PI*2);radarCtx.fill();
        radarCtx.strokeStyle='rgba(255,255,255,0.6)';radarCtx.lineWidth=1;radarCtx.stroke();radarCtx.shadowBlur=0;
        // Name on radar
        radarCtx.font='5px Share Tech Mono';radarCtx.fillStyle=col;radarCtx.textAlign='center';
        radarCtx.fillText(uid.substring(0,4),cx+pdx,cy+pdy-7);
      }else{
        // Edge arrow indicator
        const ba=Math.atan2(pdy,pdx);
        radarCtx.fillStyle=col;radarCtx.shadowBlur=5;radarCtx.shadowColor=col;
        radarCtx.beginPath();radarCtx.arc(cx+Math.cos(ba)*(R-5),cy+Math.sin(ba)*(R-5),3.5,0,Math.PI*2);radarCtx.fill();radarCtx.shadowBlur=0;
      }
      radarCtx.restore();
    });
  }
  radarCtx.restore();
  // Player dot
  radarCtx.fillStyle='#fff';radarCtx.beginPath();radarCtx.arc(cx,cy,3,0,Math.PI*2);radarCtx.fill();
  radarCtx.strokeStyle='rgba(255,200,100,.6)';radarCtx.lineWidth=1;radarCtx.beginPath();radarCtx.moveTo(cx,cy);radarCtx.lineTo(cx+Math.cos(g.angle)*14,cy+Math.sin(g.angle)*14);radarCtx.stroke();
  const sweepAngle=g.time*.002;radarCtx.strokeStyle='rgba(0,255,0,0.08)';radarCtx.lineWidth=2;radarCtx.beginPath();radarCtx.moveTo(cx,cy);radarCtx.arc(cx,cy,R,sweepAngle,sweepAngle+.4);radarCtx.stroke();
  radarCtx.strokeStyle='#1a1a1a';radarCtx.lineWidth=2;radarCtx.beginPath();radarCtx.arc(cx,cy,R,0,Math.PI*2);radarCtx.stroke();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP PIECES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMapPieces(g){
  const panel=document.getElementById('mapPanel');
  if(g.mapPiecesFound===0){panel.style.display='none';return;}
  panel.style.display='block';
  const S=110;mapCtx.clearRect(0,0,S,S);mapCtx.fillStyle='rgba(0,0,0,.9)';mapCtx.fillRect(0,0,S,S);mapCtx.strokeStyle='#1a1a1a';mapCtx.lineWidth=1;mapCtx.strokeRect(0,0,S,S);
  const sc=0.018;const cx=S/2,cy=S/2;
  mapCtx.fillStyle='#27ae60';mapCtx.fillRect(g.gatePos.x*sc+cx-2,g.gatePos.y*sc+cy-2,4,4);
  g.bossRooms.forEach((room,ri)=>{mapCtx.fillStyle=g.keys[ri]&&g.keys[ri].found?'#333':'#ff2200';mapCtx.beginPath();mapCtx.arc(room.x*sc+cx,room.y*sc+cy,3,0,Math.PI*2);mapCtx.fill();});
  g.lockedRooms.forEach(room=>{if(room.collected)return;mapCtx.fillStyle='#4466ff';mapCtx.beginPath();mapCtx.arc(room.x*sc+cx,room.y*sc+cy,2,0,Math.PI*2);mapCtx.fill();});
  g.keys.forEach(k=>{if(k.found)return;mapCtx.fillStyle=k.color;mapCtx.beginPath();mapCtx.arc(k.x*sc+cx,k.y*sc+cy,2,0,Math.PI*2);mapCtx.fill();});
  // ‚òÖ Teammates on map
  if(isMultiplayer&&multiRoom){
    Object.entries(multiRoom.players).forEach(([uid,p])=>{
      if(uid===currentUser)return;const state=mpRemoteStates[uid]||p;if(!state)return;
      if(state.ts&&Date.now()-state.ts>8000)return;
      const col=state.color||'#3498db';mapCtx.fillStyle=col;mapCtx.shadowBlur=4;mapCtx.shadowColor=col;
      mapCtx.beginPath();mapCtx.arc(state.x*sc+cx,state.y*sc+cy,3,0,Math.PI*2);mapCtx.fill();mapCtx.shadowBlur=0;
      mapCtx.font='5px Share Tech Mono';mapCtx.fillStyle=col;mapCtx.textAlign='center';
      mapCtx.fillText(uid.substring(0,4),state.x*sc+cx,state.y*sc+cy-5);
    });
  }
  mapCtx.fillStyle='#fff';mapCtx.beginPath();mapCtx.arc(g.px*sc+cx,g.py*sc+cy,2.5,0,Math.PI*2);mapCtx.fill();
  mapCtx.font='6px Share Tech Mono';mapCtx.fillStyle='#333';mapCtx.textAlign='center';mapCtx.fillText('FRAGS: '+g.mapPiecesFound+'/'+g.totalMapPieces,cx,S-4);
}
function toggleMapPanel(){const p=document.getElementById('mapPanel');p.style.display=p.style.display==='none'?'block':'none';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUEST TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateQuestTracker(g){
  if(!settings.questTracker){document.getElementById('questTracker').style.display='none';return;}
  document.getElementById('questTracker').style.display='block';
  const el=document.getElementById('questSteps');el.innerHTML='';
  const steps=[
    {done:g.mapPiecesFound>=g.totalMapPieces,active:g.mapPiecesFound<g.totalMapPieces,icon:'üó∫',text:`Map Frags ${g.mapPiecesFound}/${g.totalMapPieces}`},
    {done:g.keysFound>=g.totalKeys,active:g.mapPiecesFound>=g.totalMapPieces&&g.keysFound<g.totalKeys,icon:'‚öî',text:`Boss Keys ${g.keysFound}/${g.totalKeys}`},
    {done:false,active:g.keysFound>=g.totalKeys,icon:'üö™',text:'Reach EXIT GATE'},
  ];
  steps.forEach(s=>{
    const d=document.createElement('div');d.className='quest-step'+(s.done?' done':s.active?' active':'');
    d.innerHTML=`<span class="qs-icon">${s.done?'‚úì':s.icon}</span><span>${s.text}</span>`;el.appendChild(d);
  });
  if(g.mapPiecesFound<g.totalMapPieces){
    const nearest=g.lockedRooms.filter(r=>!r.collected).map(r=>({r,dist:Math.hypot(r.x-g.px,r.y-g.py)})).sort((a,b)=>a.dist-b.dist)[0];
    if(nearest){const d=document.createElement('div');d.className='quest-step';d.innerHTML=`<span class="qs-icon">‚Üí</span><span style="color:#4466ff;font-size:.48rem">Nearest: ${Math.round(nearest.dist)}m</span>`;el.appendChild(d);}
  }else if(g.keysFound<g.totalKeys){
    const nBoss=g.bossRooms.filter((r,ri)=>!g.keys[ri]?.found).map(r=>({r,dist:Math.hypot(r.x-g.px,r.y-g.py)})).sort((a,b)=>a.dist-b.dist)[0];
    if(nBoss){const d=document.createElement('div');d.className='quest-step';d.innerHTML=`<span class="qs-icon">‚Üí</span><span style="color:#ff2200;font-size:.48rem">Boss: ${Math.round(nBoss.dist)}m</span>`;el.appendChild(d);}
  }else{
    const gd=Math.round(Math.hypot(g.gatePos.x-g.px,g.gatePos.y-g.py));
    const d=document.createElement('div');d.className='quest-step';d.innerHTML=`<span class="qs-icon">‚Üí</span><span style="color:#27ae60;font-size:.48rem">Gate: ${gd}m</span>`;el.appendChild(d);
  }
  // Lives warning
  if(sessionDeaths>0){
    const d=document.createElement('div');d.className='quest-step';
    const remaining=MAX_DEATHS-sessionDeaths;
    d.innerHTML=`<span class="qs-icon">üíÄ</span><span style="color:${remaining===1?'#e74c3c':'#f39c12'};font-size:.48rem">${remaining} LIVES LEFT</span>`;
    el.appendChild(d);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DIRECTION ARROW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDirectionArrow(dt,g){
  directionTimer+=dt;
  if(directionTimer>=DIRECTION_INTERVAL&&!directionVisible){directionTimer=0;showDirectionArrow(g);}
}
function showDirectionArrow(g){
  if(!g)return;directionVisible=true;
  let targetX=0,targetY=0,label='';
  if(g.mapPiecesFound<g.totalMapPieces){const u=g.lockedRooms.find(r=>!r.collected);if(u){targetX=u.x;targetY=u.y;label='FIND MAP FRAGMENT üó∫';}}
  else if(g.keysFound<g.totalKeys){const b=g.bossRooms.find((r,ri)=>!g.keys[ri]?.found);if(b){targetX=b.x;targetY=b.y;label='ENTER BOSS ROOM ‚öî';}}
  else{targetX=g.gatePos.x;targetY=g.gatePos.y;label='ESCAPE GATE üö™';}
  const nearAbility=g.abilityPickups.find(ap=>!ap.found&&Math.hypot(ap.x-g.px,ap.y-g.py)<600);
  if(nearAbility&&!g.specialAbility){targetX=nearAbility.x;targetY=nearAbility.y;label='GRAB ABILITY ‚ö°';}
  const angle=Math.atan2(targetY-g.py,targetX-g.px);
  const dist=Math.round(Math.hypot(targetX-g.px,targetY-g.py));
  const ARROWS=['‚Üí','‚Üò','‚Üì','‚Üô','‚Üê','‚Üñ','‚Üë','‚Üó'];
  const arrowIdx=Math.round(((angle+Math.PI)/(Math.PI*2))*8)%8;
  document.getElementById('daArrow').textContent=ARROWS[arrowIdx];
  document.getElementById('daObj').textContent=label;
  document.getElementById('daDist').textContent=dist+' m';
  document.getElementById('directionArrow').style.display='block';
  SND.direction();
  clearTimeout(directionHideTimeout);
  directionHideTimeout=setTimeout(()=>{document.getElementById('directionArrow').style.display='none';directionVisible=false;},DIRECTION_DURATION);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOSS WARNING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function triggerBossWarning(roomIdx){
  if(bossWarningShown.has(roomIdx))return;bossWarningShown.add(roomIdx);
  const room=game.bossRooms[roomIdx];
  const bw=document.getElementById('bossWarning');document.getElementById('bossWarnName').textContent=room.bossType.toUpperCase()+' GUARDIAN ACTIVE';
  bw.style.display='flex';setTimeout(()=>bw.classList.add('show'),50);SND.bossRoar();
  let sh=0;const shakeIv=setInterval(()=>{sh++;canvas.style.transform=sh%2?'translate(3px,-3px)':'translate(-3px,3px)';if(sh>12){clearInterval(shakeIv);canvas.style.transform='none';}},60);
  setTimeout(()=>{bw.classList.remove('show');setTimeout(()=>{bw.style.display='none';},900);},3500);
}
function showLockedRoom(msg){const el=document.getElementById('lockedRoomMsg');document.getElementById('lockedRoomMsgText').textContent=msg;el.classList.add('show');SND.doorLocked();}
function closeLockedMsg(){document.getElementById('lockedRoomMsg').classList.remove('show');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gameLoop(ts){
  if(!gameRunning||!game)return;
  const dt=Math.min(ts-lastTime,50);lastTime=ts;game.time=ts;
  updatePlayer(dt,game);
  updateCreatures(dt,game);
  updateBullets(dt,game);
  updateParticles(dt,game);
  checkPickups(game);
  checkClues(game);
  checkGate(game);
  checkCapture(game);
  updateStamina(dt,game);
  checkBossRooms(game);
  checkLockedRooms(game);
  updateGuide(dt,game);
  updateDangerUI(game);
  updateAbilities(dt,game);
  updateDirectionArrow(dt,game);
  updateCreatureReveal(dt);
  updateQuestTracker(game);
  syncMpPos(dt);
  renderWorld(game);renderRadar(game);renderMapPieces(game);updateHUD();
  saveTimer+=dt;if(saveTimer>8000){saveTimer=0;autoSave();}
  animFrame=requestAnimationFrame(gameLoop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePlayer(dt,g){
  const running=keys['shift']||keys['Shift'];
  const slowMod=g.slowed>0?.5:1;let spdMul=1;if(g.berserker>0)spdMul=3;
  const spd=g.speed*(running&&g.stamina>5?1.7:1)*slowMod*spdMul;
  let dx=0,dy=0;
  if(keys['w']||keys['W']||keys['arrowup']||keys['ArrowUp'])dy-=1;
  if(keys['s']||keys['S']||keys['arrowdown']||keys['ArrowDown'])dy+=1;
  if(keys['a']||keys['A']||keys['arrowleft']||keys['ArrowLeft'])dx-=1;
  if(keys['d']||keys['D']||keys['arrowright']||keys['ArrowRight'])dx+=1;
  if(joy.active&&(Math.abs(joy.dx)>.08||Math.abs(joy.dy)>.08)){dx+=joy.dx;dy+=joy.dy;}
  if(dx||dy){
    const len=Math.hypot(dx,dy);dx/=len;dy/=len;
    const nx=g.px+dx*spd,ny=g.py+dy*spd;
    if(!isSolid(nx+dx*8,g.py))g.px=nx;if(!isSolid(g.px,ny+dy*8))g.py=ny;
    if(running&&g.stamina>0)g.stamina=Math.max(0,g.stamina-.25);
    const now=performance.now();if(now-lastStepTime>350){lastStepTime=now;SND.step();}
  }
  if(g.slowed>0)g.slowed-=dt;if(g.berserker>0)g.berserker-=dt;if(g.shielded>0)g.shielded-=dt;
  if(g.phantomEye>0)g.phantomEye-=dt;if(g.timeWarp>0)g.timeWarp-=dt;if(g.deathMark>0)g.deathMark-=dt;
  g.angle=mouseAngle;
  if(g.knockbackVx){g.px+=g.knockbackVx;g.py+=g.knockbackVy;g.knockbackVx*=.82;g.knockbackVy*=.82;if(Math.abs(g.knockbackVx)<.1){g.knockbackVx=0;g.knockbackVy=0;}}
  if(g.poisoned>0){g.poisoned-=dt;if(Math.random()<.004){if(g.shielded<=0)g.hp=Math.max(0,g.hp-1);if(g.hp<=0){SND.death();handleDeath();}}}
}
function updateStamina(dt,g){if(!(keys['shift']||keys['Shift'])&&g.stamina<100)g.stamina=Math.min(100,g.stamina+.12);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ABILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAbilities(dt,g){
  if(!g.specialAbility)return;
  if(g.specialAbilityCd>0)g.specialAbilityCd-=dt;
  const ab=g.specialAbility;const pct=g.specialAbilityCd>0?1-(g.specialAbilityCd/ab.cd):1;
  document.getElementById('abilityCdFill').style.width=(pct*100)+'%';
}
function useAbility(){
  if(!game||!game.specialAbility)return;
  if(game.specialAbilityCd>0){showNotif('‚è≥ COOLING DOWN','','#f39c12');return;}
  const ab=game.specialAbility;game.specialAbilityCd=ab.cd;ab.activate(game);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOSS ROOMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkBossRooms(g){
  g.bossRooms.forEach((room,ri)=>{
    const dist=Math.hypot(g.px-room.x,g.py-room.y);
    if(dist<room.radius+60&&!room.entered){
      if(g.mapPiecesFound<room.mapPiecesNeeded){
        if(dist<room.radius){const a=Math.atan2(g.py-room.y,g.px-room.x);g.px=room.x+Math.cos(a)*(room.radius+20);g.py=room.y+Math.sin(a)*(room.radius+20);showLockedRoom('Need '+room.mapPiecesNeeded+' map fragment(s) to enter. You have '+g.mapPiecesFound+'.');}
      }else{if(dist<room.radius&&!room.entered){room.entered=true;triggerBossWarning(ri);}}
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCKED ROOMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkLockedRooms(g){
  g.lockedRooms.forEach(room=>{
    if(room.collected)return;const dist=Math.hypot(g.px-room.x,g.py-room.y);
    if(dist<room.radius*.6){room.collected=true;g.mapPiecesFound++;SND.mapPiece();showNotif('üó∫ MAP FRAGMENT '+g.mapPiecesFound+'/'+g.totalMapPieces,MAP_PIECE_MSGS[room.mapPieceIdx]||'','#4466ff');
      queueGuide(g,{title:'MAP FRAGMENT FOUND!',msg:g.mapPiecesFound<g.totalMapPieces?`Find ${g.totalMapPieces-g.mapPiecesFound} more fragments (blue on radar)!`:'All fragments found! Boss rooms unlocked. Head to red circles on radar!'});
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREATURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCreatures(dt,g){
  if(!Array.isArray(g.creatures))return;
  const timeWarpMul=g.timeWarp>0?0.1:1;
  g.creatures.forEach(cr=>{
    if(cr.dead)return;
    if(cr.spawnGlowing){cr.spawnGlowTimer-=dt;if(cr.spawnGlowTimer<=0){cr.spawnGlowing=false;SND.creatureAlert();}return;}
    if(cr.stunTimer>0){cr.stunTimer-=dt;return;}
    const dist=Math.hypot(cr.x-g.px,cr.y-g.py);
    const toPlayer=Math.atan2(g.py-cr.y,g.px-cr.x);
    const flashDiff=Math.abs(normalizeAngle(toPlayer-(g.angle+Math.PI)));
    const inCone=flashDiff<Math.PI/3.2&&dist<settings.flashlightRadius;
    let alertRate=0;
    if(g.invisible){alertRate=0;if(dist<40)alertRate=.005;}
    else if(cr.ability==='phase'||cr.ability==='teleport'||cr.ability==='blink'){if(dist<settings.flashlightRadius*.85)alertRate=.02;}
    else if(cr.ability==='camouflage'){if(inCone&&dist<settings.flashlightRadius)alertRate=.008;else if(dist<60)alertRate=.025;}
    else{if(inCone)alertRate=.018*(1+g.caughtTimes*.12);if(dist<70)alertRate=.03;}
    if(cr.type==='mimic'&&!cr.mimicRevealed){if(dist<85||(inCone&&dist<settings.flashlightRadius*.65)){cr.mimicRevealed=true;cr.alertLevel=1;cr.state='chase';showNotif('‚ö† MIMIC!','It was never a pickup!','#f39c12');SND.creatureGroan('mimic');}}
    cr.alertLevel=Math.min(1,Math.max(0,cr.alertLevel+(alertRate>0?alertRate:-.003)));
    if(cr.alertLevel>=1&&cr.state!=='chase'){cr.state='chase';cr.lastSeen=g.time;SND.creatureAlert();SND.creatureGroan(cr.type);}
    else if(cr.alertLevel>=1){cr.lastSeen=g.time;}
    else if(cr.state==='chase'&&g.time-cr.lastSeen>5200){cr.state='patrol';cr.mimicRevealed=false;cr.alertLevel=0;}
    const spd=(cr.state==='chase'?cr.chaseSpeed:cr.speed)*timeWarpMul;
    cr.abilityTimer-=dt;if(cr.abilityTimer<0){cr.abilityTimer=2500+Math.random()*3000;triggerAbility(cr,g,dist);}
    cr.lastGroan=(cr.lastGroan||0)+dt;if(cr.lastGroan>8000+Math.random()*12000&&cr.state==='patrol'){cr.lastGroan=0;SND.creatureGroan(cr.type);}
    if(cr.ability==='charge'&&cr.charging){
      cr.chargeTimer-=dt;cr.x+=Math.cos(cr.chargeAngle)*cr.chaseSpeed*2.5*timeWarpMul;cr.y+=Math.sin(cr.chargeAngle)*cr.chaseSpeed*2.5*timeWarpMul;
      if(cr.chargeTimer<=0||isSolid(cr.x,cr.y)){cr.charging=false;cr.x-=Math.cos(cr.chargeAngle)*5;cr.y-=Math.sin(cr.chargeAngle)*5;}
    }else if(cr.state==='chase'){
      if(cr.ability==='phase'||cr.ability==='teleport'){cr.x+=Math.cos(toPlayer)*spd;cr.y+=Math.sin(toPlayer)*spd;}
      else{const nx=cr.x+Math.cos(toPlayer)*spd,ny=cr.y+Math.sin(toPlayer)*spd;if(!isSolid(nx,cr.y))cr.x=nx;else cr.patrolAngle+=.5;if(!isSolid(cr.x,ny))cr.y=ny;}
      cr.facing=toPlayer;
      if(cr.ability==='phantom'&&dist>200&&Math.random()<.0008){const ta=Math.atan2(g.py-cr.y,g.px-cr.x);cr.x=g.px-Math.cos(ta)*170;cr.y=g.py-Math.sin(ta)*170;spawnParticles(g,cr.x,cr.y,cr.color.glow||'#00f',8);}
      if(cr.ability==='blink'&&dist>120&&Math.random()<.001){cr.x=g.px+Math.cos(toPlayer+Math.PI)*(80+Math.random()*60);cr.y=g.py+Math.sin(toPlayer+Math.PI)*(80+Math.random()*60);spawnParticles(g,cr.x,cr.y,cr.color.glow||'#0ff',6);}
    }else{
      cr.wanderTimer-=dt;if(cr.wanderTimer<=0){cr.patrolAngle+=(.5-Math.random())*2.5;cr.wanderTimer=1200+Math.random()*2000;}
      const nx=cr.x+Math.cos(cr.patrolAngle)*spd,ny=cr.y+Math.sin(cr.patrolAngle)*spd;
      if(!isSolid(nx,cr.y))cr.x=nx;else cr.patrolAngle+=.6;if(!isSolid(cr.x,ny))cr.y=ny;cr.facing=cr.patrolAngle;
    }
    cr.facing=normalizeAngle(cr.facing);
  });
}

function triggerAbility(cr,g,dist){
  if(dist>300||g.shielded>0)return;
  if(cr.ability==='charge'&&cr.state==='chase'&&dist<260&&!cr.charging){cr.charging=true;cr.chargeAngle=Math.atan2(g.py-cr.y,g.px-cr.x);cr.chargeTimer=700;showDangerMsg('‚ö° RUNNER CHARGES!');}
  else if(cr.ability==='slow'&&cr.state==='chase'&&dist<200){g.slowed=2200;showDangerMsg('üì¢ SCREAMER WAIL!');spawnParticles(g,cr.x,cr.y,cr.color.glow||'#f0f',12);}
  else if(cr.ability==='knockback'&&dist<70){const a=Math.atan2(g.py-cr.y,g.px-cr.x);g.knockbackVx=Math.cos(a)*9;g.knockbackVy=Math.sin(a)*9;showDangerMsg('üíÄ BRUTE SLAM!');}
  else if(cr.ability==='poison'&&dist<100){g.poisoned=4500;showDangerMsg('‚ò£ POISONED!');}
  else if(cr.ability==='stomp'&&dist<110){g.knockbackVx=Math.cos(Math.atan2(g.py-cr.y,g.px-cr.x))*12;g.knockbackVy=Math.sin(Math.atan2(g.py-cr.y,g.px-cr.x))*12;g.slowed=1500;showDangerMsg('üåë STOMP!');}
  else if(cr.ability==='drain'&&dist<60){g.hp=Math.max(0,g.hp-2);cr.hp=Math.min(cr.maxHp,cr.hp+2);showDangerMsg('ü©∏ DRAIN!');}
  else if(cr.ability==='beam'&&cr.state==='chase'&&dist<200){showDangerMsg('üëÅ DEATH RAY!');spawnParticles(g,g.px,g.py,cr.color.glow||'#f06',10);g.hp=Math.max(0,g.hp-8);if(g.hp<=0){SND.death();handleDeath();}}
  else if(cr.ability==='spores'&&dist<120){g.slowed=1800;g.poisoned=Math.max(g.poisoned,2000);showDangerMsg('üçÑ SPORES!');}
  else if(cr.ability==='spawn'&&!cr.spawnedMinions&&cr.hp<cr.maxHp*.5){cr.spawnedMinions=true;const def=ALL_CREATURE_DEFS.find(d=>d.type==='stalker');for(let i=0;i<2;i++){const a=Math.random()*Math.PI*2;g.creatures.push(makeCreature(def,cr.x+Math.cos(a)*30,cr.y+Math.sin(a)*30,9900+Math.random()*100));}showDangerMsg('üêù HIVE SPAWNS!');}
  else if(cr.ability==='boss'&&dist<180){const a=Math.atan2(g.py-cr.y,g.px-cr.x);g.hp=Math.max(0,g.hp-5);g.knockbackVx=Math.cos(a)*8;g.knockbackVy=Math.sin(a)*8;showDangerMsg('‚ò† DEVOURER!');SND.bossRoar();if(g.hp<=0){SND.death();handleDeath();}}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BULLETS / PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBullets(dt,g){
  if(!Array.isArray(g.bullets))return;
  g.bullets.forEach(b=>{
    b.x+=Math.cos(b.angle)*14;b.y+=Math.sin(b.angle)*14;b.life-=dt;
    if(isSolid(b.x,b.y)){b.life=0;spawnParticles(g,b.x,b.y,'#888',3);return;}
    g.creatures.forEach(cr=>{
      if(cr.dead||cr.spawnGlowing||b.life<=0)return;
      if(Math.hypot(cr.x-b.x,cr.y-b.y)<cr.size+4){
        let dmg=b.dmg;if(g.deathMark>0)dmg*=2;cr.hp-=dmg;cr.alertLevel=1;cr.state='chase';
        spawnParticles(g,b.x,b.y,cr.color?.glow||'#f00',8);b.life=0;
        if(cr.hp<=0){
          cr.dead=true;spawnParticles(g,cr.x,cr.y,cr.color?.body||'#800',16);
          showNotif(cr.isBoss?'‚öî BOSS DEFEATED!':cr.type.toUpperCase()+' SLAIN','',cr.isBoss?'#27ae60':'#e74c3c');
          if(cr.isBoss)SND.bossRoar();
          if(isMultiplayer)DB.broadcast('action',{uid:currentUser,action:'creature_killed',creatureId:cr.id});
        }else if(cr.type!=='brute'&&cr.type!=='juggernaut')cr.stunTimer=400;
      }
    });
  });
  g.bullets=g.bullets.filter(b=>b.life>0);
}
function updateParticles(dt,g){if(!Array.isArray(g.particles))return;g.particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.9;p.vy*=.9;p.life-=dt;});g.particles=g.particles.filter(p=>p.life>0);}
function spawnParticles(g,x,y,color,n){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*3.5;g.particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:380,maxLife:380,r:2+Math.random()*2.5,color});}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PICKUPS / CLUES / GATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkPickups(g){
  g.pickups.forEach(pk=>{
    if(pk.found||Math.hypot(pk.x-g.px,pk.y-g.py)>24)return;pk.found=true;spawnParticles(g,pk.x,pk.y,'#f1c40f',8);
    if(pk.type==='health'){g.hp=Math.min(g.maxHp,g.hp+pk.value);showNotif('‚ô• +HEALTH','','#e74c3c');SND.pickup();}
    else if(pk.type==='ammo'){const w=g.weapons[g.activeWeapon];w.reserve=Math.min(w.reserve+pk.value*w.maxAmmo,w.maxAmmo*8);showNotif('‚¨° +AMMO','','#f39c12');SND.pickup();}
  });
  g.abilityPickups.forEach(ap=>{
    if(ap.found||Math.hypot(ap.x-g.px,ap.y-g.py)>28)return;ap.found=true;
    const ab=SPECIAL_ABILITIES[ap.abilityIdx];g.specialAbility=ab;g.specialAbilityCd=0;
    document.getElementById('abilityHud').style.display='block';
    document.getElementById('abilityName').textContent=ab.icon+' '+ab.name;document.getElementById('abilityName').style.color=ab.color;
    document.getElementById('abilityDesc').textContent=ab.desc;document.getElementById('abilityBtnIcon').textContent=ab.icon;
    SND.abilityPickup();showNotif('‚ö° ABILITY UNLOCKED!',ab.name,ab.color);
    queueGuide(g,{title:'ABILITY: '+ab.name,msg:ab.desc+' Press Q or ABILITY button to activate.'});
    spawnParticles(g,ap.x,ap.y,ab.color,16);
  });
  g.keys.forEach(k=>{
    if(k.found||Math.hypot(k.x-g.px,k.y-g.py)>30)return;k.found=true;g.keysFound++;SND.keyFound();
    showNotif(k.icon+' '+k.name+'!','key '+g.keysFound+'/'+g.totalKeys,k.color);spawnParticles(g,k.x,k.y,k.color,18);updateKeyTracker(g);
    queueGuide(g,{title:'KEY OBTAINED!',msg:`${g.keysFound}/${g.totalKeys} keys. ${g.totalKeys-g.keysFound>0?'More boss rooms remain!':'Head to EXIT GATE now!'}`});
  });
}
function checkClues(g){g.clues.forEach(cl=>{if(cl.found||Math.hypot(cl.x-g.px,cl.y-g.py)>30)return;cl.found=true;g.cluesFound++;showNotif('üìú NOTE','','#aaa');queueGuide(g,{title:'NOTE FOUND',msg:cl.text.replace(/"/g,'')});});}
function checkGate(g){
  if(Math.hypot(g.gatePos.x-g.px,g.gatePos.y-g.py)<42){
    if(g.keysFound>=g.totalKeys){SND.win();showWin();}
    else queueGuide(g,{title:'GATE IS LOCKED',msg:`You need all 4 keys. You have ${g.keysFound}. Find boss rooms (red on radar).`});
  }
}
function checkCapture(g){
  if(g.shielded>0)return;
  g.creatures.forEach(cr=>{
    if(cr.dead||cr.spawnGlowing)return;
    if(Math.hypot(cr.x-g.px,cr.y-g.py)<cr.size+8){
      if(g.invisible)return;
      g.hp=Math.max(0,g.hp-(cr.isBoss?3:2));SND.hurt();
      if(g.hp<=0){SND.death();handleDeath();}
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEATH HANDLER ‚Äî 3-death system
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleDeath(){
  if(!gameRunning)return;
  gameRunning=false;cancelAnimationFrame(animFrame);

  sessionDeaths++;
  game.caughtTimes=sessionDeaths;
  updateDeathPips();

  // Save updated death count
  if(currentUser){
    await DB.saveDeathCount(currentUser,sessionDeaths);
    if(currentUserData)currentUserData.death_count=sessionDeaths;
  }

  if(sessionDeaths>=MAX_DEATHS){
    // FINAL DEATH ‚Äî wipe everything
    await triggerFinalWipe();
    return;
  }

  // Normal death
  autoSave();
  const remaining=MAX_DEATHS-sessionDeaths;
  const ov=document.getElementById('overlayScreen');
  ov.style.display='flex';setTimeout(()=>ov.classList.add('dark'),10);
  document.getElementById('overlayTitle').textContent='YOU DIED';
  document.getElementById('overlayTitle').style.color='#c0392b';
  document.getElementById('overlayMsg').textContent=`The darkness consumed you.\n\n‚ö† WARNING: ${remaining} LIFE${remaining===1?'':'S'} REMAINING\nDie ${remaining} more time${remaining===1?'':'s'} and ALL progress will be WIPED!\n\nTip: Find üíâ Heal Surge ability or ‚ô• health pickups.`;
  document.getElementById('overlayBtns').innerHTML=`<button class="overlay-btn danger" onclick="respawn()">RESPAWN (${remaining} LIVES LEFT)</button><button class="overlay-btn" onclick="toLobby()">MAIN MENU</button>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUIDE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let guideVisible=false,guideTimeout=null;
function updateGuide(dt,g){
  if(!settings.guide)return;g.lastGuide=(g.lastGuide||0)+dt;
  if(!guideVisible&&g.guideQueue&&g.guideQueue.length>0&&g.lastGuide>3500){showGuideMsg(g.guideQueue.shift());g.lastGuide=0;}
  const maxAlert=g.creatures.filter(c=>!c.dead&&!c.spawnGlowing).reduce((m,c)=>Math.max(m,c.alertLevel),0);
  if(maxAlert>.52&&maxAlert<.82&&Math.random()<.002)queueGuide(g,{title:'‚ö† CREATURE ALERT',msg:'A creature senses you! Move away or hide behind a wall.'});
  if(maxAlert>=.82&&Math.random()<.003)queueGuide(g,{title:'üî¥ BEING CHASED!',msg:'RUN! Break line of sight behind a wall. After 5s it gives up.'});
  if(g.hp<30&&Math.random()<.003)queueGuide(g,{title:'üíâ CRITICAL HP',msg:'Find ‚ô• health pickup! You have '+(MAX_DEATHS-sessionDeaths)+' lives left. BE CAREFUL!'});
  if(g.weapons[g.activeWeapon].ammo===0&&Math.random()<.004)queueGuide(g,{title:'üî´ OUT OF AMMO',msg:'Press R to reload! Find ‚¨° ammo pickups in the world.'});
}
function queueGuide(g,msg){if(!g.guideQueue)g.guideQueue=[];if(!g.guideQueue.find(m=>m.title===msg.title))g.guideQueue.push(msg);}
function showGuideMsg(m){
  if(!settings.guide||!m)return;guideVisible=true;clearTimeout(guideTimeout);
  const panel=document.getElementById('guidePanel');while(panel.firstChild)panel.removeChild(panel.firstChild);
  const box=document.createElement('div');box.className='guide-box';
  box.innerHTML=`<div class="guide-title">${m.title}</div><div class="guide-msg">${m.msg}</div>`;
  panel.appendChild(box);requestAnimationFrame(()=>box.classList.add('visible'));
  guideTimeout=setTimeout(()=>{box.classList.remove('visible');setTimeout(()=>{if(box.parentNode)box.parentNode.removeChild(box);guideVisible=false;},500);},5000);
}
let dangerTimeout=null;
function showDangerMsg(msg){const el=document.getElementById('notifText');clearTimeout(dangerTimeout);el.style.color='#e74c3c';el.style.opacity='1';el.textContent=msg;document.getElementById('notifSub').style.opacity='0';dangerTimeout=setTimeout(()=>{el.style.opacity='0';},2200);}
function updateDangerUI(g){
  const max=g.creatures.filter(c=>!c.dead&&!c.spawnGlowing).reduce((m,c)=>Math.max(m,c.alertLevel),0);
  g.dangerLevel=max;const bar=document.getElementById('dangerBar');
  const nearBoss=g.creatures.some(c=>c.isBoss&&!c.dead&&Math.hypot(c.x-g.px,c.y-g.py)<300);
  const intensity=nearBoss?1:max;
  if(intensity>.38){const r=Math.floor(180+intensity*75);bar.style.background=`rgba(${r},0,0,${intensity*.65})`;bar.style.boxShadow=`0 0 ${intensity*18}px rgba(255,0,0,${intensity*.45})`;}
  else{bar.style.background='transparent';bar.style.boxShadow='none';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOOTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shoot(){
  if(!gameRunning||!game)return;
  const g=game,w=g.weapons[g.activeWeapon],now=performance.now();
  if(g.reloading)return;if(w.ammo<=0){reload();return;}
  let fireRate=w.fireRate;if(g.berserker>0)fireRate*=.4;
  if(now-w.lastFire<fireRate)return;
  w.lastFire=now;w.ammo--;SND.shoot(g.activeWeapon);
  for(let i=0;i<w.bullets;i++){const sp=(Math.random()-.5)*w.spread*2;g.bullets.push({x:g.px,y:g.py,angle:g.angle+sp,life:1400,dmg:w.dmg,color:w.color});}
  spawnParticles(g,g.px+Math.cos(g.angle)*16,g.py+Math.sin(g.angle)*16,'#ffee00',4);
  updateHUD();
}
function reload(){
  if(!gameRunning||!game)return;const g=game,w=g.weapons[g.activeWeapon];
  if(g.reloading||w.ammo===w.maxAmmo||w.reserve<=0)return;
  g.reloading=true;SND.reload();showNotif('RELOADING','',w.color);
  setTimeout(()=>{if(!game)return;const need=w.maxAmmo-w.ammo,take=Math.min(need,w.reserve);w.ammo+=take;w.reserve-=take;g.reloading=false;updateHUD();},w.reloadTime);
}
function setWeapon(idx){
  if(!game||idx>=game.weapons.length)return;
  game.activeWeapon=idx;updateHUD();
  document.querySelectorAll('.inv-slot').forEach((el,i)=>{el.classList.toggle('active',i===idx);if(i===idx){el.classList.add('flash');setTimeout(()=>el.classList.remove('flash'),200);}});
}
function switchWeapon(dir){if(!game)return;setWeapon((game.activeWeapon+dir+game.weapons.length)%game.weapons.length);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  if(!game||!game.weapons)return;const g=game;
  document.getElementById('hpFill').style.width=(g.hp/g.maxHp*100)+'%';
  document.getElementById('staFill').style.width=g.stamina+'%';
  const w=g.weapons[g.activeWeapon];
  document.getElementById('weaponName').textContent=w.name;
  document.getElementById('ammoCount').textContent=g.reloading?'RELOADING...':`${w.ammo} / ${w.reserve}`;
  ['inv0','inv1','inv2','inv3','inv4'].forEach((sid,i)=>{
    const el=document.getElementById(sid),item=g.inventory[i];
    el.className='inv-slot'+(i===g.activeWeapon?' active':'')+(item?' has-item':'');
    if(el.querySelector('.inv-icon'))el.querySelector('.inv-icon').textContent=item?item.icon:'‚Äî';
    const labelEl=el.querySelectorAll('span')[1];if(labelEl)labelEl.textContent=item?item.label:'';
  });
  updateDeathPips();
}
function updateKeyTracker(g){
  const el=document.getElementById('keyTracker');el.innerHTML='';
  g.keys.forEach(k=>{const d=document.createElement('div');d.className='key-slot'+(k.found?' found':'');d.innerHTML=`<span class="ks-icon">${k.found?k.icon:'?'}</span><span>${k.found?k.name:'BOSS KEY'}</span>`;el.appendChild(d);});
}
let notifTimeout=null;
function showNotif(title,sub,color='#c0392b'){
  clearTimeout(notifTimeout);const nt=document.getElementById('notifText'),ns=document.getElementById('notifSub');
  nt.style.color=color;nt.textContent=title;ns.textContent=sub||'';nt.style.opacity='1';ns.style.opacity=sub?'1':'0';
  notifTimeout=setTimeout(()=>{nt.style.opacity='0';ns.style.opacity='0';},3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIN / RESPAWN / LOBBY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showWin(){
  gameRunning=false;cancelAnimationFrame(animFrame);autoSave();
  const ov=document.getElementById('overlayScreen');ov.style.display='flex';setTimeout(()=>ov.classList.add('dark'),10);
  document.getElementById('overlayTitle').textContent='ESCAPED?';document.getElementById('overlayTitle').style.color='#27ae60';
  document.getElementById('overlayMsg').textContent='You found all 4 keys.\nThe gate opened. You walked through.\n\nBut the land followed you home.\nYou can never truly forget.';
  document.getElementById('overlayBtns').innerHTML=`<button class="overlay-btn" onclick="toLobby()">MAIN MENU</button>`;
}
function respawn(){
  const ov=document.getElementById('overlayScreen');ov.classList.remove('dark');setTimeout(()=>{ov.style.display='none';},400);
  game.hp=game.maxHp;game.reloading=false;
  game.px=MP_SPAWN.x+(Math.random()-.5)*60;game.py=MP_SPAWN.y+(Math.random()-.5)*60;
  bossWarningShown.clear();directionTimer=0;creatureRevealTimer=0;
  gameRunning=true;lastTime=performance.now();requestAnimationFrame(gameLoop);
  const remaining=MAX_DEATHS-sessionDeaths;
  showNotif('RESPAWNED',remaining+' LIVES REMAINING','#c0392b');
  updateDeathPips();
}
function toLobby(){
  const ov=document.getElementById('overlayScreen');ov.classList.remove('dark');ov.style.display='none';
  gameRunning=false;cancelAnimationFrame(animFrame);
  document.getElementById('directionArrow').style.display='none';
  mpCtx.clearRect(0,0,mpCv.width,mpCv.height);
  updateLobbyDeaths();
  showScreen('lobbyScreen');
}
function pauseGame(){
  gameRunning=false;cancelAnimationFrame(animFrame);autoSave();
  document.getElementById('directionArrow').style.display='none';
  showScreen('lobbyScreen');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(fresh,worldSeed){
  const saved=(!fresh&&currentUserData?.game_state)?JSON.parse(JSON.stringify(currentUserData.game_state)):null;
  game=saved||newGameState(worldSeed);
  // Patch missing fields
  ['creatures','bullets','particles','clues','keys','pickups'].forEach(k=>{if(!Array.isArray(game[k]))game[k]=[];});
  if(!Array.isArray(game.weapons))game.weapons=newGameState().weapons;
  if(!Array.isArray(game.inventory))game.inventory=newGameState().inventory;
  if(!game.gatePos)game.gatePos={x:1200,y:-1200};
  if(game.hp===undefined)game.hp=100;if(game.maxHp===undefined)game.maxHp=100;
  if(game.stamina===undefined)game.stamina=100;if(!game.guideQueue)game.guideQueue=[];
  if(!game.keysFound)game.keysFound=0;if(!game.totalKeys)game.totalKeys=4;
  if(!game.knockbackVx)game.knockbackVx=0;if(!game.knockbackVy)game.knockbackVy=0;
  if(!game.mapPiecesFound)game.mapPiecesFound=0;if(!game.totalMapPieces)game.totalMapPieces=4;
  if(!game.bossRooms)game.bossRooms=JSON.parse(JSON.stringify(BOSS_ROOMS));
  if(!game.lockedRooms)game.lockedRooms=JSON.parse(JSON.stringify(LOCKED_ROOMS));
  if(!game.mapFragments)game.mapFragments=[false,false,false,false];
  if(!game.abilityPickups)game.abilityPickups=[];
  if(!game.specialAbility)game.specialAbility=null;
  if(!game.specialAbilityCd)game.specialAbilityCd=0;
  if(fresh){game.px=MP_SPAWN.x;game.py=MP_SPAWN.y;}
  game.invisible=false;game.berserker=0;game.shielded=0;game.phantomEye=0;game.timeWarp=0;game.deathMark=0;
  bossWarningShown.clear();directionTimer=0;creatureRevealTimer=0;creatureRevealActive=false;
  if(fresh||game.creatures.length===0)spawnWorld(game);
  gameRunning=true;showScreen('gameScreen');updateHUD();updateKeyTracker(game);updateDeathPips();
  lastTime=performance.now();saveTimer=0;
  if(animFrame)cancelAnimationFrame(animFrame);
  animFrame=requestAnimationFrame(gameLoop);
  if(game.specialAbility){
    const ab=game.specialAbility;
    document.getElementById('abilityHud').style.display='block';
    document.getElementById('abilityName').textContent=ab.icon+' '+ab.name;document.getElementById('abilityName').style.color=ab.color;
    document.getElementById('abilityDesc').textContent=ab.desc;document.getElementById('abilityBtnIcon').textContent=ab.icon;
  }else{document.getElementById('abilityHud').style.display='none';}
  showNotif('THE FORGOTTEN LAND','find fragments ‚Üí bosses ‚Üí escape','#c0392b');
  const livesRemaining=MAX_DEATHS-sessionDeaths;
  if(livesRemaining<MAX_DEATHS)showNotif('‚ö† '+livesRemaining+' LIVES LEFT','die again and all progress is lost!','#e74c3c');
  setTimeout(()=>{if(gameRunning)showDirectionArrow(game);},6000);
}

async function autoSave(){if(!currentUser||!game)return;try{await DB.saveState(currentUser,game);}catch(e){}}
function normalizeAngle(a){while(a>Math.PI)a-=2*Math.PI;while(a<-Math.PI)a+=2*Math.PI;return a;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('authId').addEventListener('keydown',e=>{if(e.key==='Enter')handleAuth();});
document.getElementById('authPass').addEventListener('keydown',e=>{if(e.key==='Enter')handleAuth();});
document.addEventListener('click',()=>{try{getAudio()?.resume();}catch(e){}},{once:true});
document.addEventListener('touchstart',()=>{try{getAudio()?.resume();}catch(e){}},{once:true});
window.addEventListener('load',()=>{detectMobile();if(!isMobile){document.getElementById('joystickZone').style.display='none';document.getElementById('actionZone').style.display='none';}});
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
</script>
</body>
</html>